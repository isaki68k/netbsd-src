                        ; --------------------------------------
                        ; zasm: assemble "xplx.asm"
                        ; opts: --z180
                        ; date: 2018-07-30 18:15:16
                        ; --------------------------------------


                        ; vi: set ts=8:
                        ;
                        ; LUNA XP multiplexed device firmware
                        ;
                        ; (C) 2018 moveccr
                        ; BSD Licence
                        ;
                        ;
                        ; used language:
                        ;  zasm 4.1
                        ;  http://k1.spdns.de/Develop/Projects/zasm
                        ;
                        ; XP memory map
                        ;
                        ; type : SH, PR, IN, NC
                        ;     SH: host shared memory, 64kB, PA 00000 - 0FFFF
                        ;     PR: private memory, 32kB, PA 28000-2FFFF
                        ;     IN: HD647180 internal 512 bytes memory
                        ;     NC: not connected (00 or FF or image readable, maybe)
                        ;
                        ; start end type desc
                        ;  0000 00FF SH RESET/RST etc.
                        ;  0100 01FF SH shared variables
                        ;  0200 0FFF SH resident program
                        ;  1000 7FFF SH PAM/PCM buffer 28K
                        ;  8000 8FFF SH PSG buffer 4K
                        ;  9000 9FFF SH LPR buffer 4K
                        ;  A000 DFFF SH FDC buffer 16K
                        ;  E000 EFFF PR program/stack
                        ;  F000 FDFF NC bus error (00 or FF)
                        ;  FE00 FFDF IN PAM player
                        ;  FFE0 FFFF IN interrupt vector
                        ;
                        ; shared variable area
                        ;  0100    XPBUS
                        ;  0110    TIME
                        ;  0120    PAM
                        ;  0130    PCM
                        ;  0140    PSG
                        ;  0150    SPK
                        ;  0160    LPR
                        ;  0170    FDC
                        ;  0180    SIO0
                        ;  0190    SIO1
                        ; device ID = bit 7-4
                        ;
                        ; XP internal device usage
                        ;  PRT0  device dispatcher/TIME
                        ;  PRT1  PCM
                        ;  PT2   unused
                        ;  ASCI0 SIO0
                        ;  ASCI1 SIO1	本体表記の関係で、入れ替える?
                        ;
                        ; READY-CMD-RESULT-RUN プロトコル
                        ; XP 視点
                        ; READY
                        ;   コマンドを受け付けできるとき != 0
                        ;   受付できないとき 0
                        ; CMD
                        ;   ホスト側が送信してくるコマンド
                        ;   コマンドなしは 0
                        ;   XP がコマンドを受け付けると、READY=0 CMD=0 の順で、XP が 0 にする
                        ; RESULT
                        ;   コマンド実行結果。
                        ;   RESULT=x READY=1 の順で書き込む。
                        ;   ハードリセット、またはホストが 0 クリアする。
                        ; RUN
                        ;   コマンド実行中は != 0
                        ;   実行していないときは 0
                        ;   実行完了時、RESULT=x RUN=0 READY=1 の順で書き込む。
                        ;
                        ; 通常シーケンス
                        ;  READY を上げる
                        ;  CMD の立ち上がりを待つ
                        ;  READY を下げる
                        ;  RUN を上げる
                        ;  CMD を下げる
                        ;  実行
                        ;  RESULT を書く
                        ;  RUN を下げる
                        ;  READY を上げる
                        ;
                        ; ホスト視点
                        ; 実行完了を待つとき
                        ;  while (READY == 0);	// 受付可能待ち
                        ;  RESULT=0;		// 結果クリア
                        ;  CMD=x;		// コマンド送信
                        ;  while (RESULT == 0);	// 実行完了待ち
                        ;  if (RESULT==ERROR) error();	// エラー確認
                        ;
                        
                        ;
                        ; XPBUS
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;
                        ;  +4.b STAT_RESET
                        ;        ファームウェア転送で 0　にされる。
                        ;        リセット位置の実行のたびに +1 
                        ;        すなわち何もなければ 1 になっている。
                        ;  +5.3 align
                        ;  +8.w PRT0_TIMER
                        ;        ==256(1200Hz)
                        ;  +A.w INTR1_DEV
                        ;        bitmap of INTR1 device ID
                        ;  +C.w INTR5_DEV
                        ;        bitmap of INTR5 device ID
                        ;
                        ; TIME
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;
                        ;  +4.w TIMECOUNTER
                        ;
                        ; PAM
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;
                        ;  +4.b ENC
                        ;        エンコードフォーマット識別子。
                        ;  +5.b REPT
                        ;        REPT 回数。
                        ;  +6.w CYCLE_CLK
                        ;        基準クロック数
                        ;        クエリで返される。
                        ;  +8.b REPT_CLK
                        ;        1 REPT あたりのクロック数。
                        ;        クエリで返される。
                        ;  +9.b REPT_MAX
                        ;        REPT に設定できる最大値。
                        ;        クエリで返される。
                        ;
                        ;  +E.w STAT_PTR
                        ;
                        ; PCM
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;  +4.b ENC
                        ;  +6.w PRT1_TIMER
                        ;        PCM >=10(30.72kHz,200clk)
                        ;
                        ;  +E.w STAT_PTR
                        ;
                        ; PSG
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;
                        ; SPK
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;
                        ;  +4.b VOL
                        ;        PSG ボリュームレジスタ値。
                        ;  +6.w FREQ
                        ;        PSG FREQ レジスタ値。
                        ;  +8.w TIME
                        ;        1200Hz 単位の持続時間。
                        ;  +A.w REMAIN
                        ;        内部変数：残り時間。
                        ;
                        ; LPR
                        ;  TBD.
                        ; FDC
                        ;  TBD.
                        ;
                        ; SIO0
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;				; 送受信のバッファリングも検討したが
                        ;				; わりに合わない
                        ;  +4.b TXCMD
                        ;  +5.b TXSTAT
                        ;  +6.b TX
                        ;  +A.b RXCMD
                        ;  +B.b RXSTAT
                        ;  +C.b RX
                        ;
                        ; SIO1
                        ;  +0.b READY
                        ;  +1.b CMD
                        ;  +2.b RESULT
                        ;  +3.b RUN
                        ;				; 送受信のバッファリングも検討したが
                        ;				; わりに合わない
                        ;  +4.b TXCMD
                        ;  +5.b TXSTAT
                        ;  +6.b TX
                        ;  +A.b RXCMD
                        ;  +B.b RXSTAT
                        ;  +C.b RX
                        
                        	.Z180
                        
                        ; ######## device ID
                        
0000:                   #define DEVID_XPBUS	0
0001:                   #define DEVID_TIME	1
0002:                   #define DEVID_PAM	2
0003:                   #define DEVID_PCM	3
0004:                   #define DEVID_PSG	4
0005:                   #define DEVID_SPK	5
0006:                   #define DEVID_LPR	6
0007:                   #define DEVID_FDC	7
0008:                   #define DEVID_SIO0	8
0009:                   #define DEVID_SIO1	9
                        ; ######## define
                        
0001:                   #define PAM_CMD_START	1
0002:                   #define PAM_CMD_QUERY	2
                        
0001:                   #define PAM_ENC_PAM2A	1
0002:                   #define PAM_ENC_PAM2B	2
0003:                   #define PAM_ENC_PAM3A	3
0004:                   #define PAM_ENC_PAM3B	4
0005:                   #define PAM_ENC_PAM1P	5
                        
0001:                   #define PCM_CMD_START	1
                        
0001:                   #define PCM_ENC_PCM1	1
0002:                   #define PCM_ENC_PCM2	2
0003:                   #define PCM_ENC_PCM3	3
                        
0001:                   #define SPK_CMD_START	1
0002:                   #define SPK_CMD_STOP	2
0003:                   #define SPK_CMD_KEEP	3
                        
                        
                        ; #### RESULT
0001:                   #define XPLX_R_OK		1
00FE:                   #define XPLX_R_ERROR_PARAM	254
00FF:                   #define XPLX_R_UNKNOWN_CMD	255
                        
                        
                        ; ######## switch
                        ; 0 = USE STAT_PTR for userland test mode
                        ; 1 = USE HOSTINTR for kernel (normal)
0001:                   #define USE_INTR	1
                        
                        ; ######## constants
                        ; xp to host level 1 interrupt port
00B0:                   HOSTINTR1	.EQU	0B0H
                        ; xp to host level 5 interrupt port
00A0:                   HOSTINTR5	.EQU	0A0H
                        
                        ; PAM use HOSTINTR5
00A0:                   PAM_HOSTINTR	.EQU	HOSTINTR5
                        ; PCM use HOSTINTR5
00A0:                   PCM_HOSTINTR	.EQU	HOSTINTR5
                        
                        ; I/O PORT
000C:                   TMDR0L	.EQU	0CH
000D:                   TMDR0H	.EQU	0DH
000E:                   RLDR0L	.EQU	0EH
000F:                   RLDR0H	.EQU	0FH
0010:                   TCR	.EQU	10H
0014:                   TMDR1L	.EQU	14H
0015:                   TMDR1H	.EQU	15H
0016:                   RLDR1L	.EQU	16H
0017:                   RLDR1H	.EQU	17H
                        
0083:                   PSG_ADR	.EQU	83H		; PSG address (out)
0082:                   PSG_DAT	.EQU	82H		; data output
0083:                   PSG_IN	.EQU	83H		; data input (in)
                        
1000:                   INITIAL_SP:	.EQU	01000H
F000:                   PRIVATE_SP:	.EQU	0F000H
                        
                        ; ######## macros
                        
                        ADD_HL_A:	.MACRO
                        	ADD	A,L
                        	LD	L,A
                        	JR	NC,$ + 3
                        	INC	H
                        	.ENDM
                        
                        WAIT3	.MACRO
                        	NOP
                        	.ENDM
                        
                        WAIT4	.MACRO
                        	LD	A,A
                        	.ENDM
                        
                        WAIT6	.MACRO
                        	NOP
                        	NOP
                        	.ENDM
                        
                        WAIT7	.MACRO
                        	LD	A,A			; 4+3=7
                        	NOP
                        	.ENDM
                        
                        WAIT8	.MACRO
                        	LD	A,A			; 4*2=8
                        	LD	A,A
                        	.ENDM
                        
                        WAIT9	.MACRO
                        	NOP				; 3*3=9
                        	NOP
                        	NOP
                        	.ENDM
                        
                        WAIT10	.MACRO
                        	LD	A,A			; 4+3*2=10
                        	NOP
                        	NOP
                        	.ENDM
                        
                        WAIT11	.MACRO
                        	LD	A,A			; 4*2+3=11
                        	LD	A,A
                        	NOP
                        	.ENDM
                        
                        WAIT12	.MACRO
                        	LD	A,A			; 4*3=12
                        	LD	A,A
                        	LD	A,A
                        	.ENDM
                        
                        WAIT13	.MACRO
                        	LD	A,A			; 4+3*3=13
                        	NOP
                        	NOP
                        	NOP
                        	.ENDM
                        
                        WAIT16	.MACRO
                        	LD	A,A
                        	LD	A,A
                        	LD	A,A
                        	LD	A,A
                        	.ENDM
                        
                        WAIT17	.MACRO
                        	LD	A,A			; 4*2+3*3=17
                        	LD	A,A
                        	NOP
                        	NOP
                        	NOP
                        	.ENDM
                        
                        WAIT19	.MACRO
                        	LD	A,A			; 4*4+3=19
                        	LD	A,A
                        	LD	A,A
                        	LD	A,A
                        	NOP
                        	.ENDM
                        
                        ; ######## RESET/RST
0000:                   	.ORG	0000H
0000:                   RESET:
0000: C30002   [10]     	JP	ENTRY
                        
0003: FFFFFFFF          	.ORG	0038H
0007: FF...             
0038:                   INT0:
0038: C325E2   [10]     	JP	INTR_INT0
                        
003B: FFFFFFFF          	.ORG	0066H
003F: FF...             
0066:                   NMI:
0066: ED45     [14]     	RETN
                        
0068: FFFFFFFF          	.ORG	00FCH
006C: FF...             
00FC:                   XPLX_MAGIC::			; MAGIC
00FC: 58504C58          	.DB	"XPLX"
                        
                        ; ######## shared variables
                        ; XPBUS
                        	.ORG	0100H
0100:                   XPLX_VAR_BASE::
0100:                   XPBUS_READY::
0100: 00                	.DB	0
0101:                   XPBUS_CMD::
0101: 00                	.DB	0
0102:                   XPBUS_RESULT::
0102: 00                	.DB	0
0103:                   XPBUS_RUN::
0103: 00                	.DB	0
                        
0104:                   XPBUS_STAT_RESET::		; reset count
0104: 00                	.DB	0
0105: 000000            	.DB	0,0,0		; reserved
                        
0108:                   XPBUS_PRT0_TIMER::		; PRT0 TIMER TLDR (devices dispatch)
0108: 0000              	.DW	0
010A:                   XPBUS_INTR1_DEV::		; HOSTINTR1 device
010A: 0000              	.DW	0
010C:                   XPBUS_INTR5_DEV::		; HOSTINTR5 device
010C: 0000              	.DW	0
                        
                        ; TIME
010E: FFFF              	.ORG	0110H
0110:                   TIME_READY::
0110: 00                	.DB	0
0111:                   TIME_CMD::
0111: 00                	.DB	0
0112:                   TIME_RESULT::
0112: 00                	.DB	0
0113:                   TIME_RUN::
0113: 00                	.DB	0
0114:                   TIME_TIMECOUNTER::		; timecounter (TBD.)
0114: 0000              	.DW	0
                        
                        ; PAM
0116: FFFFFFFF          	.ORG	0120H
011A: FF...             
0120:                   PAM_READY::
0120: 00                	.DB	0
0121:                   PAM_CMD::
0121: 00                	.DB	0
0122:                   PAM_RESULT::
0122: 00                	.DB	0
0123:                   PAM_RUN::
0123: 00                	.DB	0
                        
0124:                   PAM_ENC::
0124: 00                	.DB	0
0125:                   PAM_REPT::
0125: 00                	.DB	0
0126:                   PAM_CYCLE_CLK::
0126: 0000              	.DW	0
0128:                   PAM_REPT_CLK::
0128: 00                	.DB	0
0129:                   PAM_REPT_MAX::
0129: 00                	.DB	0
                        
012A: 00000000          	.DB	0,0,0,0		; reserved
012E:                   PAM_STAT_PTR::
012E: 0000              	.DW	0
                        
                        ; PCM
                        	.ORG	0130H
0130:                   PCM_READY::
0130: 00                	.DB	0
0131:                   PCM_CMD::
0131: 00                	.DB	0
0132:                   PCM_RESULT::
0132: 00                	.DB	0
0133:                   PCM_RUN::
0133: 00                	.DB	0
                        
0134:                   PCM_ENC::
0134: 00                	.DB	0
0135: 00                	.DB	0		; reserved
0136:                   PCM_PRT1_TIMER::			; PRT1 TIMER TLDR (PCM)
0136: 0000              	.DW	0
                        
0138: 00000000          	.DB	0,0,0,0,0,0	; reserved
013C: 0000              
013E:                   PCM_STAT_PTR::
013E: 0000              	.DW	0
                        
                        ; PSG
                        	.ORG	0140H
0140:                   PSG_READY::
0140: 00                	.DB	0
0141:                   PSG_CMD::
0141: 00                	.DB	0
0142:                   PSG_RESULT::
0142: 00                	.DB	0
0143:                   PSG_RUN::
0143: 00                	.DB	0
                        
                        ; SPK
0144: FFFFFFFF          	.ORG	0150H
0148: FF...             
0150:                   SPK_READY::
0150: 00                	.DB	0
0151:                   SPK_CMD::
0151: 00                	.DB	0
0152:                   SPK_RESULT::
0152: 00                	.DB	0
0153:                   SPK_RUN::
0153: 00                	.DB	0
                        
0154:                   SPK_VOL::
0154: 00                	.DB	0
0155: 00                	.DB	0		; reserved
0156:                   SPK_FREQ::
0156: 0000              	.DW	0
0158:                   SPK_TIME::
0158: 0000              	.DW	0
015A:                   SPK_REMAIN::
015A: 0000              	.DW	0
                        
                        ; LPR
015C: FFFFFFFF          	.ORG	0160H
0160:                   LPR_READY::
0160: 00                	.DB	0
0161:                   LPR_CMD::
0161: 00                	.DB	0
0162:                   LPR_RESULT::
0162: 00                	.DB	0
0163:                   LPR_RUN::
0163: 00                	.DB	0
                        	; TBD.
                        
0001:                   LPR_CMD_START	.EQU	1
                        
                        ; FDC
0164: FFFFFFFF          	.ORG	0170H
0168: FF...             
0170:                   FDC_READY::
0170: 00                	.DB	0
0171:                   FDC_CMD::
0171: 00                	.DB	0
0172:                   FDC_RESULT::
0172: 00                	.DB	0
0173:                   FDC_RUN::
0173: 00                	.DB	0
                        ; TBD.
                        
0001:                   FDC_CMD_START	.EQU	1
                        
                        ; SIO0
0174: FFFFFFFF          	.ORG	0180H
0178: FF...             
0180:                   SIO0_READY::
0180: 00                	.DB	0
0181:                   SIO0_CMD::
0181: 00                	.DB	0
0182:                   SIO0_RESULT::
0182: 00                	.DB	0
0183:                   SIO0_RUN::
0183: 00                	.DB	0
                        
0184:                   SIO0_TXCMD::
0184: 00                	.DB	0
0185:                   SIO0_TXSTAT::
0185: 00                	.DB	0
0186:                   SIO0_TX::
0186: 00                	.DB	0
0187: FFFFFF            	.DS	3
018A:                   SIO0_RXCMD::
018A: 00                	.DB	0
018B:                   SIO0_RXSTAT::
018B: 00                	.DB	0
018C:                   SIO0_RX::
018C: 00                	.DB	0
                        
                        ; SIO1
018D: FFFFFF            	.ORG	0190H
0190:                   SIO1_READY::
0190: 00                	.DB	0
0191:                   SIO1_CMD::
0191: 00                	.DB	0
0192:                   SIO1_RESULT::
0192: 00                	.DB	0
0193:                   SIO1_RUN::
0193: 00                	.DB	0
                        
0194:                   SIO1_TXCMD::
0194: 00                	.DB	0
0195:                   SIO1_TXSTAT::
0195: 00                	.DB	0
0196:                   SIO1_TX::
0196: 00                	.DB	0
0197: FFFFFF            	.DS	3
019A:                   SIO1_RXCMD::
019A: 00                	.DB	0
019B:                   SIO1_RXSTAT::
019B: 00                	.DB	0
019C:                   SIO1_RX::
019C: 00                	.DB	0
                        
                        
                        ; ######## Bootstrap program
019D: FFFFFFFF          	.ORG	0200H
01A1: FF...             
0200:                   ENTRY:
0200: F3       [ 4]     	DI
0201: 310010   [14]     	LD	SP,INITIAL_SP
                        
                        				; inc reset count
0204: 210401   [24]     	LD	HL, XPBUS_STAT_RESET
0207: 34       [35]     	INC	(HL)
                        
                        				; initial devices
                        				; READY=0
0208: AF       [39]     	XOR	A
0209: 320001   [52]     	LD	(XPBUS_READY),A
020C: 321001   [65]     	LD	(TIME_READY),A
020F: 322001   [78]     	LD	(PAM_READY),A
0212: 323001   [91]     	LD	(PCM_READY),A
0215: 324001   [104]    	LD	(PSG_READY),A
0218: 325001   [117]    	LD	(SPK_READY),A
021B: 326001   [130]    	LD	(LPR_READY),A
021E: 327001   [143]    	LD	(FDC_READY),A
0221: 328001   [156]    	LD	(SIO0_READY),A
0224: 329001   [169]    	LD	(SIO1_READY),A
                        
                        				; init XP internal devices
                        				; internal I/O address = 00H - 3FH
0227: 3E00     [176]    	LD	A,00H		; IOA7[7]=0 IOSTP[5]=0
003F:                   ICR	.EQU	3FH
0229: ED393F   [184]    	OUT0	(ICR),A
                        
                        				; memory wait = 0
                        				; I/O wait = 3
                        				; no DMA
022C: 3E20     [191]    	LD	A,20H		; MWI[76]=0 IWI[54]=2(3wait) DMS[32]=0 DIM[10]=0
0032:                   DCNTL	.EQU	32H
022E: ED3932   [199]    	OUT0	(DCNTL),A
                        				; disable refresh
0231: 3E03     [206]    	LD	A,03H		; REFE[7]=0 REFW[6]=0 CYC[10]=3(80state)
0036:                   RCR	.EQU	36H
0233: ED3936   [214]    	OUT0	(RCR),A
                        
                        				; prepare memory map
                        				; MMU
0038:                   CBR	.EQU	38H
0039:                   BBR	.EQU	39H
003A:                   CBAR	.EQU	3AH
                        				; Common0: VA=0000H -> PA=00000H SH
                        				; Bank   : VA=E000H -> PA=28000H PR
                        				; Common1: VA=F000H -> PA=FF000H IN
0236: 3EF0     [221]    	LD	A,0F0H
0238: ED3938   [229]    	OUT0	(CBR),A
023B: 3E1A     [236]    	LD	A,1AH
023D: ED3939   [244]    	OUT0	(BBR),A
0240: 3EFE     [251]    	LD	A,0FEH
0242: ED393A   [259]    	OUT0	(CBAR),A
                        
                        				; internal RAM addressing
                        				; for no-wait access
                        				; PA=FxxxxH にしたらノーウェイトになった。
                        				; PA=0xxxxH だとウェイトが入った。
                        				; ほかのアドレスは未調査。
                        				; built-in RAM VA=FE00H PA=FFE00H
0245: 3EF0     [266]    	LD	A,0F0H
0051:                   RMCR	.EQU	51H
0247: ED3951   [274]    	OUT0	(RMCR),A
                        				; disable external interrupt
                        				; TODO: if use "Host to XP" interrupt, change here
024A: 3E00     [281]    	LD	A,00H		; TRAP[7]=0 ITE2[2]=0 ITE1[1]=0 ITE0[0]=0
0034:                   ITC	.EQU	34H
024C: ED3934   [289]    	OUT0	(ITC),A
                        				; Interrupt Vector Low = E
                        				; I = FFH
                        				; Interrupt Vector Address = FFE0H
024F: 3EE0     [296]    	LD	A,0E0H
0033:                   IL	.EQU	33H
0251: ED3933   [304]    	OUT0	(IL),A
0254: 3EFF     [311]    	LD	A,0FFH
0256: ED47     [320]    	LD	I,A
                        				; interrupt mode 1
0258: ED56     [328]    	IM	1
                        
025A: CD8F02   [345]    	CALL	INIT_PSG
                        
                        	; TODO
                        	; INIT FDC
                        	; INIT LPR
                        	; INIT SIO
                        
                        				; INIT PRT0,1
                        				; TIE1[5]=TIE0[4]=0
                        				; TOC1[3]=TOC0[2]=0
                        				; TDE1[1]=TDE0[0]=0
025D: 3E00     [352]    	LD	A,00H
025F: ED3910   [360]    	OUT0	(TCR),A
                        				; prepare PRT0
0262: 2A0801   [376]    	LD	HL,(XPBUS_PRT0_TIMER)
0265: ED290E   [384]    	OUT0	(RLDR0L),L
0268: ED290C   [392]    	OUT0	(TMDR0L),L
026B: ED210F   [400]    	OUT0	(RLDR0H),H
026E: ED210D   [408]    	OUT0	(TMDR0H),H
                        				; TIE0, TID0 ON
                        				; TIE0[4]=1 TDE0[0]=1
0271: 3E11     [415]    	LD	A,11H
0273: ED3910   [423]    	OUT0	(TCR),A
                        
                        				; copy to private memory
0276: 21B402   [433]    	LD	HL,PROG_ORG
0279: 1100E0   [443]    	LD	DE,PRIVATE_RAM
027C: 016604   [453]    	LD	BC,PROG_ORG_LEN
027F: EDB0     [469|21] 	LDIR
                        				; interrupt vector copy to internal memory
0281: 211A07   [479]    	LD	HL,VECTOR_ORG
0284: 11E0FF   [489]    	LD	DE,VECTOR
0287: 011B00   [499]    	LD	BC,VECTOR_ORG_LEN
028A: EDB0     [515|21] 	LDIR
                        
                        				; jump to XPBUS
028C: C300E0   [525]    	JP	XPBUS
                        
                        ; initialize PSG registers
                        ; break all regs
028F:                   INIT_PSG:
                        				; init PSG
                        				; PSG R0-R6 All 00H
028F: 3E00     [ 7]     	LD	A,0
0291: 0607     [14]     	LD	B,7
0293: 0E82     [21]     	LD	C,PSG_DAT
0295: 1600     [28]     	LD	D,0
0297:                   PSG_CLEAR_06:
0297: D383     [11]     	OUT	(PSG_ADR),A
0299: ED51     [23]     	OUT	(C),D
029B: 3C       [27]     	INC	A
029C: 10F9     [35|40]  	DJNZ	PSG_CLEAR_06
                        				; PSG mixer
                        				; tone = off, noise = off
                        				; IOA, IOB = output
029E: 3E07     [42]     	LD	A,7
02A0: 16FF     [49]     	LD	D,0FFH
02A2: D383     [60]     	OUT	(PSG_ADR),A
02A4: ED51     [72]     	OUT	(C),D
                        				; PSG volume and envelope
                        				; PSG R8-R15 all 0
02A6: 3E08     [79]     	LD	A,8
02A8: 0608     [86]     	LD	B,8
02AA: 1600     [93]     	LD	D,0
02AC:                   PSG_CLEAR_8F:
02AC: D383     [11]     	OUT	(PSG_ADR),A
02AE: ED51     [23]     	OUT	(C),D
02B0: 3C       [27]     	INC	A
02B1: 10F9     [35|40]  	DJNZ	PSG_CLEAR_8F
                        				; TODO: PSG I/O Port
02B3: C9       [45]     	RET
                        
                        ; ######## buffers
                        	.PHASE	1000H
1000:                   PAM_BUF::
1000:                   PCM_BUF::
                        	.DEPHASE
                        	.PHASE 08000H
7000:                   PAM_BUF_LEN::	.EQU	$-PAM_BUF
7000:                   PCM_BUF_LEN::	.EQU	$-PCM_BUF
8000:                   PSG_BUF::
                        	.DEPHASE
                        	.PHASE 09000H
1000:                   PSG_BUF_LEN::	.EQU	$-PSG_BUF
9000:                   LPR_BUF::
                        	.DEPHASE
                        	.PHASE 0A000H
1000:                   LPR_BUF_LEN::	.EQU	$-LPR_BUF
A000:                   FDC_BUF::
                        	.DEPHASE
                        
                        ; ######## private memory program
                        	.PHASE 0E000H
4000:                   FDC_BUF_LEN::	.EQU	$-FDC_BUF
                        
02B4:                   PROG_ORG:	.EQU	$$
E000:                   PRIVATE_RAM:
                        
E000:                   XPBUS:
02B4: 3100F0   [10]     	LD	SP,PRIVATE_SP
                        
                        				; devices READY=1
02B7: 3E01     [17]     	LD	A,1
02B9: 320001   [30]     	LD	(XPBUS_READY),A
02BC: 321001   [43]     	LD	(TIME_READY),A
02BF: 322001   [56]     	LD	(PAM_READY),A
02C2: 323001   [69]     	LD	(PCM_READY),A
02C5: 324001   [82]     	LD	(PSG_READY),A
02C8: 325001   [95]     	LD	(SPK_READY),A
02CB: 326001   [108]    	LD	(LPR_READY),A
02CE: 327001   [121]    	LD	(FDC_READY),A
02D1: 328001   [134]    	LD	(SIO0_READY),A
02D4: 329001   [147]    	LD	(SIO1_READY),A
                        
                        				; wait for PRT0
02D7: FB       [151]    	EI
02D8: 76       [155]    	HALT
                        
E025:                   INTR_PRT0:
                        ; #### Periodic devices
                        ; 1200Hz
                        ; ここから呼び出される DISPATCH ルーチンは、
                        ; o. A にコマンドが入っている
                        ; o. AF, HL は破壊して良い。
                        ; o. EI 状態で呼ばれることに注意。
                        ; o. EI 状態でリターンすること。
                        ; o. 裏レジスタは PCM 専用。
                        ; o. PAM 以外、0.83 msec 以内にリターンすること。
                        
02D9: F5       [166]    	PUSH	AF
02DA: E5       [177]    	PUSH	HL
                        				; first EI, for PRT1
02DB: FB       [181]    	EI
                        
E028:                   TIMECOUNTER_INCR:
                        				; timecounter
02DC: 2A1401   [197]    	LD	HL,(TIME_TIMECOUNTER)
02DF: 23       [203]    	INC	HL
02E0: 221401   [219]    	LD	(TIME_TIMECOUNTER),HL
                        
                        ; #### XPBUS devices dispatcher
                        
E02F:                   DEVICES_DISPATCH:
02E3: 3A0101   [232]    	LD	A,(XPBUS_CMD)
02E6: B7       [236]    	OR	A
02E7: C472E0   [246|253]	CALL	NZ,XPBUS_DISPATCH
                        
02EA: 3A2101   [259]    	LD	A,(PAM_CMD)
02ED: B7       [263]    	OR	A
02EE: C428E2   [273|280]	CALL	NZ,PAM_DISPATCH
                        
02F1: 3A3101   [286]    	LD	A,(PCM_CMD)
02F4: B7       [290]    	OR	A
02F5: C486E0   [300|307]	CALL	NZ,PCM_DISPATCH
                        
02F8: 3A4101   [313]    	LD	A,(PSG_CMD)
02FB: B7       [317]    	OR	A
02FC: C4F3E1   [327|334]	CALL	NZ,PSG_DISPATCH
                        
02FF: 3A5101   [340]    	LD	A,(SPK_CMD)
0302: B7       [344]    	OR	A
0303: C463E1   [354|361]	CALL	NZ,SPK_DISPATCH
                        
0306: 3A6101   [367]    	LD	A,(LPR_CMD)
0309: B7       [371]    	OR	A
030A: C4FDE1   [381|388]	CALL	NZ,LPR_DISPATCH
                        
030D: 3A7101   [394]    	LD	A,(FDC_CMD)
0310: B7       [398]    	OR	A
0311: C407E2   [408|415]	CALL	NZ,FDC_DISPATCH
                        
0314: 3A8101   [421]    	LD	A,(SIO0_CMD)
0317: B7       [425]    	OR	A
0318: C411E2   [435|442]	CALL	NZ,SIO0_DISPATCH
                        
031B: 3A9101   [448]    	LD	A,(SIO1_CMD)
031E: B7       [452]    	OR	A
031F: C41BE2   [462|469]	CALL	NZ,SIO1_DISPATCH
                        
0322: E1       [472]    	POP	HL
0323: F1       [482]    	POP	AF
0324: ED4D     [496]    	RETI
                        
                        ; #### XPBUS
                        
E072:                   XPBUS_DISPATCH:
                        	; not implemented
0326: AF       [500]    	XOR	A
0327: 320101   [513]    	LD	(XPBUS_CMD),A
032A: 3EFF     [520]    	LD	A,XPLX_R_UNKNOWN_CMD
032C: 320201   [533]    	LD	(XPBUS_RESULT),A
032F: C9       [543]    	RET
                        
                        ; #### TIME
                        
E07C:                   TIME_DISPATCH:
                        	; not implemented
0330: AF       [547]    	XOR	A
0331: 321101   [560]    	LD	(TIME_CMD),A
0334: 3EFF     [567]    	LD	A,XPLX_R_UNKNOWN_CMD
0336: 321201   [580]    	LD	(TIME_RESULT),A
0339: C9       [590]    	RET
                        
                        ; #### PAM は末尾
                        
                        ; #### PCM driver core
                        
                        ; PCM 割り込みは裏レジスタを専有します。
                        ; メインルーチン側では裏レジスタを使用してはいけません。
                        
                        ; #### PCM play start
E086:                   PCM_DISPATCH:
033A: FE01     [597]    	CP	PCM_CMD_START
033C: 2806     [604|609]	JR	Z,PCM_START
                        
033E: 3EFF     [611]    	LD	A,XPLX_R_UNKNOWN_CMD
E08C:                   PCM_ERROR:
0340: 323201   [624]    	LD	(PCM_RESULT),A
0343: C9       [634]    	RET
                        
E090:                   PCM_START:
                        				; if READY==0 return
0344: 3A3001   [647]    	LD	A,(PCM_READY)
0347: B7       [651]    	OR	A
0348: C8       [656|662]	RET	Z
                        				; check ENC
0349: 3A3401   [669]    	LD	A,(PCM_ENC)
034C: 3D       [673]    	DEC	A
034D: 280A     [680|685]	JR	Z,PCM_START_OK	; PCM1 = 1
034F: 3D       [684]    	DEC	A
0350: 2807     [691|696]	JR	Z,PCM_START_OK	; PCM2 = 2
0352: 3D       [695]    	DEC	A
0353: 2804     [702|707]	JR	Z,PCM_START_OK	; PCM3 = 3
                        
0355: 3EFE     [709]    	LD	A,XPLX_R_ERROR_PARAM
0357: 18E7     [721]    	JR	PCM_ERROR
                        
E0A5:                   PCM_START_OK:
                        				; A = 0
0359: 323001   [734]    	LD	(PCM_READY),A
035C: 323101   [747]    	LD	(PCM_CMD),A
                        
                        
                        				; prepare vector
035F: F3       [751]    	DI
                        				; set PRT1 vector
0360: 21FCE0   [761]    	LD	HL,PCM_INTR
0363: 22E6FF   [777]    	LD	(VEC_PRT1),HL
                        				; prepare register
0366: D9       [781]    	EXX
                        
0367: CD8F02   [798]    	CALL	INIT_PSG
                        
                        				; make interrupt handler
036A: 3A3401   [811]    	LD	A,(PCM_ENC)
036D: 3D       [815]    	DEC	A
036E: 280D     [822|827]	JR	Z,PCM_SET_PCM1
0370: 3D       [826]    	DEC	A
0371: 2805     [833|838]	JR	Z,PCM_SET_PCM2
E0BF:                   PCM_SET_PCM3:
0373: 2148E1   [843]    	LD	HL,PCM3
0376: 1808     [855]    	JR	PCM_SET
E0C4:                   PCM_SET_PCM2:
0378: 2139E1   [865]    	LD	HL,PCM2
037B: 1803     [877]    	JR	PCM_SET
E0C9:                   PCM_SET_PCM1:
037D: 2131E1   [887]    	LD	HL,PCM1
E0CC:                   PCM_SET:
0380: 2205E1   [903]    	LD	(PCM_INTR_JMP),HL
                        
0383: 210010   [913]    	LD	HL,PCM_BUF
0386: 018308   [923]    	LD	BC,0800H + PSG_ADR
0389: 110907   [933]    	LD	DE,0709H
                        
038C: D9       [937]    	EXX
                        
                        				; TIE1, TDE1 OFF
038D: ED3810   [945]    	IN0	A,(TCR)
0390: E6DD     [952]    	AND	0DDH		; TIE1[5]=0 TDE1[1]=0
0392: ED3910   [960]    	OUT0	(TCR),A
                        				; prepare PRT1
0395: 2A3601   [976]    	LD	HL,(PCM_PRT1_TIMER)
0398: ED2916   [984]    	OUT0	(RLDR1L),L
039B: ED2117   [992]    	OUT0	(RLDR1H),H
039E: ED2914   [1000]   	OUT0	(TMDR1L),L
03A1: ED2115   [1008]   	OUT0	(TMDR1H),H
                        				; TIE1, TID1 ON
03A4: F622     [1015]   	OR	22H		; TIE1[5]=1 TDE1[5]=1
03A6: ED3910   [1023]   	OUT0	(TCR),A
                        
03A9: FB       [1027]   	EI
                        
03AA: 3E01     [1034]   	LD	A,1
03AC: 323301   [1047]   	LD	(PCM_RUN),A
                        
03AF: C9       [1057]   	RET
                        
                        
                        
                        ; #### PCM interrupt handler
                        
E0FC:                   PCM_INTR:
                        				; PRT1 interrupt
03B0: 08       [1061]   	EX	AF,AF
03B1: D9       [1065]   	EXX
                        				; interrupt acknowledge
                        				; reset PRT1 Interrupt
03B2: ED3010   [1073]   	IN0	F,(TCR)
03B5: ED3014   [1081]   	IN0	F,(TMDR1L)
                        
                        				; ジャンプ先は書き換えられる
E105:                   PCM_INTR_JMP:	.EQU	$+1
03B8: C331E1   [1091]   	JP	PCM1
                        
E107:                   PCM_INTR_NEXT:
03BB: 07       [1095]   	RLCA
03BC: 381D     [1102|110	JR	C,PCM_RELOAD
                        				; inc ptr after reload check
03BE: 23       [1108]   	INC	HL
03BF: 07       [1112]   	RLCA
03C0: 381C     [1119|112	JR	C,PCM_STAT
03C2: 07       [1123]   	RLCA
03C3: 301B     [1130|113	JR	NC,PCM_NORMAL
                        
                        ; PCM RESET attention
                        ; in: HL = EXIT address
E111:                   PCM_RESET:
                        				; PRT1 intr stop
03C5: ED3810   [1138]   	IN0	A,(TCR)
                        				; TIE1,TDE1 OFF
03C8: E6DD     [1145]   	AND	0DDH		; TIE1[5]=0 TDE1[1]=0
03CA: ED3910   [1153]   	OUT0	(TCR),A
                        				; PLAY STOP
03CD: AF       [1157]   	XOR	A
03CE: 323301   [1170]   	LD	(PCM_RUN),A
03D1: 3E01     [1177]   	LD	A,XPLX_R_OK
03D3: 323201   [1190]   	LD	(PCM_RESULT),A
03D6: 323001   [1203]   	LD	(PCM_READY),A
                        
03D9: 1805     [1215]   	JR	PCM_EXIT
                        
                        ; PCM common code
                        
E127:                   PCM_RELOAD:
03DB: 210010   [1225]   	LD	HL,PCM_BUF
E12A:                   PCM_STAT:
                        #if USE_INTR
03DE: D3A0     [1236]   	OUT	(PCM_HOSTINTR),A
                        #else
                        	LD	(PCM_STAT_PTR),HL
                        #endif
E12C:                   PCM_NORMAL:
E12C:                   PCM_EXIT:
03E0: D9       [1240]   	EXX
03E1: 08       [1244]   	EX	AF,AF
03E2: FB       [1248]   	EI
03E3: ED4D     [1262]   	RETI
                        
                        ; #### PCM core code
                        
E131:                   PCM1:
                        				; PSG REG=8
03E5: ED41     [1274]   	OUT	(C),B
                        				; read attention or CH0
03E7: 7E       [1281]   	LD	A,(HL)
03E8: D382     [1292]   	OUT	(PSG_DAT),A
03EA: C307E1   [1302]   	JP	PCM_INTR_NEXT
                        
E139:                   PCM2:
03ED: 56       [1309]   	LD	D,(HL)
03EE: 23       [1315]   	INC	HL
03EF: 7E       [1322]   	LD	A,(HL)
                        
03F0: ED41     [1334]   	OUT	(C),B
03F2: ED1182   [1342]   	OUT0	(PSG_DAT),D
03F5: ED59     [1354]   	OUT	(C),E
03F7: D382     [1365]   	OUT	(PSG_DAT),A
03F9: C307E1   [1375]   	JP	PCM_INTR_NEXT
                        
E148:                   PCM3:
03FC: 5E       [1382]   	LD	E,(HL)
03FD: 23       [1388]   	INC	HL
03FE: 56       [1395]   	LD	D,(HL)
03FF: 23       [1401]   	INC	HL
0400: 7E       [1408]   	LD	A,(HL)
                        
0401: E5       [1419]   	PUSH	HL
0402: 210A09   [1429]   	LD	HL,090AH
0405: ED41     [1441]   	OUT	(C),B
0407: ED1982   [1449]   	OUT0	(PSG_DAT),E
040A: ED61     [1461]   	OUT	(C),H
040C: ED1182   [1469]   	OUT0	(PSG_DAT),D
040F: ED69     [1481]   	OUT	(C),L
0411: D382     [1492]   	OUT	(PSG_DAT),A
0413: E1       [1502]   	POP	HL
0414: C307E1   [1512]   	JP	PCM_INTR_NEXT
                        
                        ; #### SPK
E163:                   SPK_DISPATCH:
0417: FE01     [1519]   	CP	SPK_CMD_START
0419: 280E     [1526|153	JR	Z,SPK_START
041B: FE02     [1533]   	CP	SPK_CMD_STOP
041D: 2850     [1540|154	JR	Z,SPK_STOP
041F: FE03     [1547]   	CP	SPK_CMD_KEEP
0421: 286E     [1554|155	JR	Z,SPK_KEEP
                        
0423: 3EFF     [1561]   	LD	A,XPLX_R_UNKNOWN_CMD
0425: 325201   [1574]   	LD	(SPK_RESULT),A
0428: C9       [1584]   	RET
                        
E175:                   SPK_START:
0429: 3A5001   [1597]   	LD	A,(SPK_READY)
042C: B7       [1601]   	OR	A
042D: C8       [1606|161	RET	Z
                        
042E: AF       [1610]   	XOR	A
042F: 325001   [1623]   	LD	(SPK_READY),A
                        				; next to CMD_KEEP
0432: 3E03     [1630]   	LD	A,SPK_CMD_KEEP
0434: 325101   [1643]   	LD	(SPK_CMD),A
0437: 3E01     [1650]   	LD	A,1
0439: 325301   [1663]   	LD	(SPK_RUN),A
                        
                        				; set REMAIN
043C: 2A5801   [1679]   	LD	HL,(SPK_TIME)
043F: 225A01   [1695]   	LD	(SPK_REMAIN),HL
                        
0442: F3       [1699]   	DI
                        				; PSG CH3 FREQ
0443: 2A5601   [1715]   	LD	HL,(SPK_FREQ)
0446: 3E04     [1722]   	LD	A,4
0448: ED3983   [1730]   	OUT0	(PSG_ADR),A
044B: ED2982   [1738]   	OUT0	(PSG_DAT),L
044E: 3E05     [1745]   	LD	A,5
0450: ED3983   [1753]   	OUT0	(PSG_ADR),A
0453: ED2182   [1761]   	OUT0	(PSG_DAT),H
                        				; PSG CH3 VOL
0456: 3E0A     [1768]   	LD	A,10
0458: D383     [1779]   	OUT	(PSG_ADR),A
045A: 3A5401   [1792]   	LD	A,(SPK_VOL)
045D: D382     [1803]   	OUT	(PSG_DAT),A
                        				; save PSG R7
045F: 3E07     [1810]   	LD	A,7
0461: ED3983   [1818]   	OUT0	(PSG_ADR),A
0464: DB83     [1829]   	IN	A,(PSG_IN)
0466: 32F2E1   [1842]   	LD	(SPK_PSGR7),A
                        				; PSG CH3 TONE ON
0469: E6FB     [1849]   	AND	0FBH
046B: D382     [1860]   	OUT	(PSG_DAT),A
                        
046D: 182D     [1872]   	JR	SPK_EXIT
                        
E1BB:                   SPK_STOP:
046F: 3A5001   [1885]   	LD	A,(SPK_READY)
0472: B7       [1889]   	OR	A
0473: C8       [1894|190	RET	Z
                        
E1C0:                   SPK_STOP_CORE:
0474: AF       [1898]   	XOR	A
0475: 325001   [1911]   	LD	(SPK_READY),A
0478: 325101   [1924]   	LD	(SPK_CMD),A
                        
047B: F3       [1928]   	DI
                        				; restore PSG R7
047C: 3E07     [1935]   	LD	A,7
047E: D383     [1946]   	OUT	(PSG_ADR),A
0480: 3AF2E1   [1959]   	LD	A,(SPK_PSGR7)
0483: D382     [1970]   	OUT	(PSG_DAT),A
                        				; PSG CH3 VOL=0
0485: 3E0A     [1977]   	LD	A,10
0487: D383     [1988]   	OUT	(PSG_ADR),A
0489: AF       [1992]   	XOR	A
048A: D382     [2003]   	OUT	(PSG_DAT),A
                        
048C: 325301   [2016]   	LD	(SPK_RUN),A
                        
048F: 180B     [2028]   	JR	SPK_EXIT
                        
E1DD:                   SPK_KEEP:
                        				; REMAIN == 0, then stop
0491: 2A5A01   [2044]   	LD	HL,(SPK_REMAIN)
0494: 7C       [2048]   	LD	A,H
0495: B5       [2052]   	OR	L
0496: 28DC     [2059|206	JR	Z,SPK_STOP_CORE
                        
0498: 2B       [2065]   	DEC	HL
0499: 225A01   [2081]   	LD	(SPK_REMAIN),HL
                        
E1E8:                   SPK_EXIT:
049C: FB       [2085]   	EI
049D: 3E01     [2092]   	LD	A,XPLX_R_OK
049F: 325201   [2105]   	LD	(SPK_RESULT),A
04A2: 325001   [2118]   	LD	(SPK_READY),A
04A5: C9       [2128]   	RET
                        
E1F2:                   SPK_PSGR7:
04A6: 00                	.DB	0
                        
                        ; ######## PSG
E1F3:                   PSG_DISPATCH:
                        	; not implemented
04A7: AF       [2132]   	XOR	A
04A8: 324101   [2145]   	LD	(PSG_CMD),A
04AB: 3EFF     [2152]   	LD	A,XPLX_R_UNKNOWN_CMD
04AD: 324201   [2165]   	LD	(PSG_RESULT),A
04B0: C9       [2175]   	RET
                        ; ######## LPR
E1FD:                   LPR_DISPATCH:
                        	; not implemented
04B1: AF       [2179]   	XOR	A
04B2: 326101   [2192]   	LD	(LPR_CMD),A
04B5: 3EFF     [2199]   	LD	A,XPLX_R_UNKNOWN_CMD
04B7: 326201   [2212]   	LD	(LPR_RESULT),A
04BA: C9       [2222]   	RET
                        ; ######## FDC
E207:                   FDC_DISPATCH:
                        	; not implemented
04BB: AF       [2226]   	XOR	A
04BC: 327101   [2239]   	LD	(FDC_CMD),A
04BF: 3EFF     [2246]   	LD	A,XPLX_R_UNKNOWN_CMD
04C1: 327201   [2259]   	LD	(FDC_RESULT),A
04C4: C9       [2269]   	RET
                        
                        ; ######## SIO
E211:                   SIO0_DISPATCH:
                        	; not implemented
04C5: AF       [2273]   	XOR	A
04C6: 328101   [2286]   	LD	(SIO0_CMD),A
04C9: 3EFF     [2293]   	LD	A,XPLX_R_UNKNOWN_CMD
04CB: 328201   [2306]   	LD	(SIO0_RESULT),A
04CE: C9       [2316]   	RET
                        
E21B:                   SIO1_DISPATCH:
                        	; not implemented
04CF: AF       [2320]   	XOR	A
04D0: 329101   [2333]   	LD	(SIO1_CMD),A
04D3: 3EFF     [2340]   	LD	A,XPLX_R_UNKNOWN_CMD
04D5: 329201   [2353]   	LD	(SIO1_RESULT),A
04D8: C9       [2363]   	RET
                        
E225:                   INTR_INT0:
E225:                   INTR_ASCI0:
E225:                   INTR_ASCI1:
                        				; TBD
04D9: FB       [2367]   	EI
04DA: ED4D     [2381]   	RETI
                        
                        ; #### PAM play start
                        
E228:                   PAM_DISPATCH:
04DC: FE01     [2388]   	CP	PAM_CMD_START
04DE: 284E     [2395|240	JR	Z,PAM_START
04E0: FE02     [2402]   	CP	PAM_CMD_QUERY
04E2: 2825     [2409|241	JR	Z,PAM_QUERY
                        
04E4: 3EFF     [2416]   	LD	A,XPLX_R_UNKNOWN_CMD
04E6: 322201   [2429]   	LD	(PAM_RESULT),A
04E9: C9       [2439]   	RET
                        
                        ; PAM ENC -> PAM Driver MAP address
                        ; OUT: HL = MAP address
                        ; if error, direct return to main routine
E236:                   PAM_ENC_MAP:
04EA: 3A2401   [2452]   	LD	A,(PAM_ENC)
04ED: 3D       [2456]   	DEC	A
04EE: 3812     [2463|246	JR	C,PAM_ERROR_ENC
                        
04F0: FE04     [2470]   	CP	PAM_DRIVER_MAP_LEN / 16		; 16 bytes / entry
04F2: D24EE2   [2480|248	JP	NC,PAM_ERROR_ENC
                        
04F5: 87       [2484]   	ADD	A,A		; A *= 16
04F6: 87       [2488]   	ADD	A,A
04F7: 87       [2492]   	ADD	A,A
04F8: 87       [2496]   	ADD	A,A
                        
04F9: 21E6E2   [2506]   	LD	HL,PAM_DRIVER_MAP
                        	ADD_HL_A
04FC: 85       [2510]   	ADD	A,L
04FD: 6F       [2514]   	LD	L,A
04FE: 3001     [2521|252	JR	NC,$ + 3
0500: 24       [2525]   	INC	H
0501: C9       [2535]   	RET
                        
E24E:                   PAM_ERROR_ENC:
0502: E1       [2545]   	POP	HL		; discard caller PC
E24F:                   PAM_ERROR_PARAM:
0503: 3EFE     [2552]   	LD	A,XPLX_R_ERROR_PARAM
0505: 322201   [2565]   	LD	(PAM_RESULT),A
0508: C9       [2575]   	RET			; return to main
                        
E255:                   PAM_QUERY:
0509: CD36E2   [2592]   	CALL	PAM_ENC_MAP	; get ENC to MAP
                        
050C: 3A2001   [2605]   	LD	A,(PAM_READY)
050F: B7       [2609]   	OR	A
0510: C8       [2614|262	RET	Z
                        
0511: AF       [2618]   	XOR	A
0512: 322001   [2631]   	LD	(PAM_READY),A
                        
0515: C5       [2642]   	PUSH	BC
0516: D5       [2653]   	PUSH	DE
                        
0517: 010C00   [2663]   	LD	BC,12		; MAP offset 12 = CYCLE_CLK
051A: 09       [2674]   	ADD	HL,BC
                        
                        				; CYCLE_CLK, REPT_CLK, REPT_MAX
051B: 112601   [2684]   	LD	DE,PAM_CYCLE_CLK
051E: 010400   [2694]   	LD	BC,4
0521: EDB0     [2710|21]	LDIR
                        
0523: D1       [2720]   	POP	DE
0524: C1       [2730]   	POP	BC
                        
0525: 3E01     [2737]   	LD	A,XPLX_R_OK
0527: 322201   [2750]   	LD	(PAM_RESULT),A
052A: 322001   [2763]   	LD	(PAM_READY),A
052D: C9       [2773]   	RET
                        
                        
E27A:                   PAM_START:
052E: CD36E2   [2790]   	CALL	PAM_ENC_MAP	; get ENC to MAP
                        
0531: 3E0F     [2797]   	LD	A,15
                        	ADD_HL_A		; HL points REPT_MAX
0533: 85       [2801]   	ADD	A,L
0534: 6F       [2805]   	LD	L,A
0535: 3001     [2812|281	JR	NC,$ + 3
0537: 24       [2816]   	INC	H
                        
0538: 3A2501   [2829]   	LD	A,(PAM_REPT)
053B: BE       [2836]   	CP	(HL)
053C: 2804     [2843|284	JR	Z,PAM_START_OK	; == OK
053E: 3802     [2850|285	JR	C,PAM_START_OK	; < OK
0540: 18C1     [2862]   	JR	PAM_ERROR_PARAM
                        
E28E:                   PAM_START_OK:
0542: 3A2001   [2875]   	LD	A,(PAM_READY)
0545: B7       [2879]   	OR	A
0546: C8       [2884|289	RET	Z
                        
0547: AF       [2888]   	XOR	A
0548: 322001   [2901]   	LD	(PAM_READY),A
                        
                        				; never normal return
                        				; PAM never EI
054B: F3       [2905]   	DI
054C: CD8F02   [2922]   	CALL	INIT_PSG
                        
054F: CD36E2   [2939]   	CALL	PAM_ENC_MAP	; re- get ENC to MAP
                        
                        				; copy to internal RAM
0552: 1100FE   [2949]   	LD	DE,PAM_DRIVER
                        
0555: F9       [2955]   	LD	SP,HL		; SP = top of Map entry
0556: E1       [2965]   	POP	HL		; HEAD
0557: C1       [2975]   	POP	BC		; HEAD_LEN
0558: EDB0     [2991|21]	LDIR
                        
055A: 3A2501   [3004]   	LD	A,(PAM_REPT)
                        
E2A9:                   PAM_REPT_LOOP:
055D: E1       [3014]   	POP	HL		; REPT
055E: C1       [3024]   	POP	BC		; REPT_LEN
                        
055F: 3D       [3028]   	DEC	A
0560: 3808     [3035|304	JR	C,PAM_REPT_END
                        
0562: EDB0     [3051|21]	LDIR
                        
0564: 3B       [3057]   	DEC	SP
0565: 3B       [3063]   	DEC	SP
0566: 3B       [3069]   	DEC	SP
0567: 3B       [3075]   	DEC	SP
0568: 18F3     [3087]   	JR	PAM_REPT_LOOP
E2B6:                   PAM_REPT_END:
                        
056A: E1       [3097]   	POP	HL		; TAIL
056B: C1       [3107]   	POP	BC		; TAIL_LEN
056C: EDB0     [3123|21]	LDIR
                        
                        				; buffer pointer
056E: 210010   [3133]   	LD	HL,PAM_BUF
                        #if USE_INTR
                        #else
                        	LD	(PAM_STAT_PTR),HL
                        #endif
                        				; prefetch
0571: F9       [3139]   	LD	SP,HL			; 4
0572: D1       [3149]   	POP	DE
                        
                        ; I/O WAIT 3 -> 2
                        ; PSG の address / write 時間 は 300ns なので、
                        ; 1.8432 clock あればよいので 1 wait から設定できるはずだが、
                        ; 2 wait に設定すると out 命令が 12 clock となり、
                        ; 共有メモリに対する POP の 9+3=12 clock と一致して
                        ; クロック整合を取りやすくなるため、2 wait に設定する。
                        ; なお PSG の read は 400ns 必要なため、2 wait だとあやしい。
                        ; また HOSTINTR 用の I/O への out で wait を満足するかどうかは
                        ; 未確定だけど、HOSTINTR 機構はデータバスの値ではなく
                        ; アドレスへの出力で動作するため、ウェイトに関係なく動作すると
                        ; 期待してみる。
0573: 3E10     [3156]   	LD	A,10H		; IWI[54]=1(2wait)
0575: ED3932   [3164]   	OUT0	(DCNTL),A
                        
0578: 3E01     [3171]   	LD	A,1
057A: 322301   [3184]   	LD	(PAM_RUN),A
                        
057D: C300FE   [3194]   	JP	PAM_DRIVER
                        
E2CC:                   PAM_RESET:
                        				; XPBUS に制御を戻す
0580: 3100F0   [3204]   	LD	SP,PRIVATE_SP
                        
                        ; I/O WAIT 2 -> 3
0583: 3E20     [3211]   	LD	A,20H		; IWI[54]=2(3wait)
0585: ED3932   [3219]   	OUT0	(DCNTL),A
                        
0588: CD8F02   [3236]   	CALL	INIT_PSG
                        
058B: AF       [3240]   	XOR	A
058C: 322301   [3253]   	LD	(PAM_RUN),A
                        
058F: 3E01     [3260]   	LD	A,XPLX_R_OK
0591: 322201   [3273]   	LD	(PAM_RESULT),A
0594: 322001   [3286]   	LD	(PAM_READY),A
                        
0597: C300E0   [3296]   	JP	XPBUS
                        
E2E6:                   PAM_DRIVER_MAP:
                        				; 16 bytes / entry
059A: DA05              	DW	PAM2A_HEAD_ORG
059C: 2100              	DW	PAM2A_HEAD_LEN
059E: FB05              	DW	PAM2A_REPT_ORG
05A0: 0700              	DW	PAM2A_REPT_LEN
05A2: 0206              	DW	PAM2A_TAIL_ORG
05A4: 1D00              	DW	PAM2A_TAIL_LEN
05A6: CC00              	DW	204		;CYCLE_CLK
05A8: 24                	DB	36		;REPT_CLK
05A9: 25                	DB	37		;REPT_MAX
                        
05AA: 1F06              	DW	PAM2B_HEAD_ORG
05AC: 1800              	DW	PAM2B_HEAD_LEN
05AE: 3706              	DW	PAM2B_REPT_ORG
05B0: 0400              	DW	PAM2B_REPT_LEN
05B2: 3B06              	DW	PAM2B_TAIL_ORG
05B4: 1800              	DW	PAM2B_TAIL_LEN
05B6: 9800              	DW	152		;CYCLE_CLK
05B8: 18                	DB	24		;REPT_CLK
05B9: 39                	DB	57		;REPT_MAX
                        
05BA: 5306              	DW	PAM3A_HEAD_ORG
05BC: 3100              	DW	PAM3A_HEAD_LEN
05BE: 8406              	DW	PAM3A_REPT_ORG
05C0: 0A00              	DW	PAM3A_REPT_LEN
05C2: 8E06              	DW	PAM3A_TAIL_ORG
05C4: 2600              	DW	PAM3A_TAIL_LEN
05C6: 2A01              	DW	298		;CYCLE_CLK
05C8: 33                	DB	51		;REPT_CLK
05C9: 18                	DB	24		;REPT_MAX
                        
05CA: B406              	DW	PAM3B_HEAD_ORG
05CC: 1A00              	DW	PAM3B_HEAD_LEN
05CE: CE06              	DW	PAM3B_REPT_ORG
05D0: 0600              	DW	PAM3B_REPT_LEN
05D2: D406              	DW	PAM3B_TAIL_ORG
05D4: 1500              	DW	PAM3B_TAIL_LEN
05D6: 8800              	DW	136		;CYCLE_CLK
05D8: 24                	DB	36		;REPT_CLK
05D9: 26                	DB	38		;REPT_MAX
                        	
                        
                        
0040:                   PAM_DRIVER_MAP_LEN:	.EQU	$-PAM_DRIVER_MAP
                        
                        	.DEPHASE
                        
                        
                        
                        ; ######## PAM drivers
                        	.PHASE 0FE00H
                        				; all PAM drivers have same address=0FE00H
FE00:                   PAM_DRIVER:
                        	.DEPHASE
                        
                        ; #### PAM2A
                        
                        	.PHASE 0FE00H
05DA:                   PAM2A_HEAD_ORG:	.EQU	$$
FE00:                   PAM2A_HEAD:
FE00:                   PAM2A:
                        				; PAM2A
                        				; 12+0:12+12 = 1:2 PAM
                        				; PAM 36clk 170.667kHz
                        				; output PAM wave = normal 5 + antinoise 1
                        
                        				; 1 PAM cycle = 204 clk
                        
                        				; 6.144E6 / (204 + 36*n)
                        
                        				; sampling freqs:
                        				;  0: 30118
                        				; 37:  4000
                        
                        				; no STAT for first time
05DA: C31AFE   [10]     	JP	PAM2A_LOOP
                        
FE03:                   PAM2A_RELOAD:
05DD: ED59     [22]     	OUT	(C),E
05DF: ED51     [34]     	OUT	(C),D
05E1: 310010   [44]     	LD	SP,PAM_BUF		;9
                        	WAIT3
05E4: 00       [48]     	NOP
                        
FE0B:                   PAM2A_STAT:
                        #if USE_INTR
05E5: ED59     [60]     	OUT	(C),E
05E7: ED51     [72]     	OUT	(C),D
05E9: D3A0     [83]     	OUT	(PAM_HOSTINTR),A		;10+2
                        #else
                        				; STAT_PTR モードでの遅れはしょうがない
                        	OUT	(C),E
                        	OUT	(C),D
                        	LD	(PAM_STAT_PTR),SP		;19+3
                        #endif
                        
FE11:                   PAM2A_NORMAL:
05EB: ED59     [95]     	OUT	(C),E
05ED: ED51     [107]    	OUT	(C),D
                        				; prefetch
05EF: D1       [117]    	POP	DE			;9+3
                        
05F0: ED69     [129]    	OUT	(C),L
05F2: ED61     [141]    	OUT	(C),H
                        				; うまくいくかはわからない
                        				; 本来 wait 12 だが PAM 遷移ノイズを
                        				; 低減するため待たない
FE1A:                   PAM2A_LOOP:
                        				; prefetched DE
05F4: ED59     [153]    	OUT	(C),E
05F6: ED51     [165]    	OUT	(C),D
                        				; HL = DE for save current sample
05F8: 6B       [169]    	LD	L,E			;4
05F9: 62       [173]    	LD	H,D			;4
                        				; A = attention
05FA: 7B       [177]    	LD	A,E			;4
                        
0021:                   PAM2A_HEAD_LEN:	.EQU	$-PAM2A_HEAD
                        
05FB:                   PAM2A_REPT_ORG:	.EQU	$$
FE21:                   PAM2A_REPT:
05FB: ED59     [12]     	OUT	(C),E
05FD: ED51     [24]     	OUT	(C),D
                        	WAIT12
05FF: 7F       [28]     	LD	A,A			; 4*3=12
0600: 7F       [32]     	LD	A,A
0601: 7F       [36]     	LD	A,A
0007:                   PAM2A_REPT_LEN:	.EQU	$-PAM2A_REPT
                        
0602:                   PAM2A_TAIL_ORG:	.EQU	$$
FE28:                   PAM2A_TAIL:
                        				; このブロックは動的再配置されるので
                        				; このブロック"への"ジャンプは困難
                        				; "からの"ジャンプは可能。
0602: ED59     [12]     	OUT	(C),E
0604: ED51     [24]     	OUT	(C),D
0606: 07       [28]     	RLCA
                        				; attention bit
                        				; bit7=1, reload
                        				; must be JP
0607: DA03FE   [38|38]  	JP	C,PAM2A_RELOAD		; jump=9 no=6
                        
                        	WAIT3
060A: 00       [42]     	NOP
060B: ED59     [54]     	OUT	(C),E
060D: ED51     [66]     	OUT	(C),D
060F: 07       [70]     	RLCA				; 3
                        				; bit6=1, stat
                        				; must be JP
0610: DA0BFE   [80|80]  	JP	C,PAM2A_STAT		; jump=9 no=6
                        
                        	WAIT3
0613: 00       [84]     	NOP
0614: ED59     [96]     	OUT	(C),E
0616: ED51     [108]    	OUT	(C),D
0618: 07       [112]    	RLCA				; 3
                        				; bit5=0, normal
                        				; must be JP
0619: D211FE   [122|122]	JP	NC,PAM2A_NORMAL		; jump=9 no=6
                        				; attention=001, reset
061C: C3CCE2   [132]    	JP	PAM_RESET
001D:                   PAM2A_TAIL_LEN:	.EQU	$-PAM2A_TAIL
                        
                        				; cycle
                        				; 5 * (12*3) + 12*2 = 204
                        
                        	.DEPHASE
                        
                        ; #### PAM2B
                        
                        	.PHASE 0FE00H
                        				; all PAM drivers have same address=0FE00H
061F:                   PAM2B_HEAD_ORG:	.EQU	$$
FE00:                   PAM2B_HEAD:
FE00:                   PAM2B:
                        				; PAM2B
                        				; averaged 1:1 PAM
                        				; wait (4,7), (3,9), (9,12), (12,0)
                        				; phase wait 28:28
                        				; clk  35, 36, 45, 36
                        				; PAM 176, 171, 137, 171 kHz
                        				; output PAM wave = 4
                        
                        				; 1 PAM cycle = 152 clk
                        
                        				; 6.144E6 / (152 + 24*n)
                        
                        				; sampling freqs:
                        				;  0: 40421
                        				; 57:  4042
                        
                        				; no STAT for first time
061F: C311FE   [10]     	JP	PAM2B_LOOP
                        
FE03:                   PAM2B_RELOAD:
0622: ED59     [22]     	OUT	(C),E
0624: 310010   [32]     	LD	SP,PAM_BUF		;9
                        
FE08:                   PAM2B_STAT:
                        #if USE_INTR
0627: ED51     [44]     	OUT	(C),D
0629: D3A0     [55]     	OUT	(PAM_HOSTINTR),A		;10+2
                        #else
                        				; STAT_PTR モードでの遅れはしょうがない
                        	OUT	(C),D
                        	LD	(PAM_STAT_PTR),SP		;19+3
                        #endif
                        
FE0C:                   PAM2B_NORMAL:
062B: ED59     [67]     	OUT	(C),E
                        				; prefetch
062D: D1       [77]     	POP	DE			;9+3
062E: ED41     [89]     	OUT	(C),B
FE11:                   PAM2B_LOOP:
                        				; prefetched DE
0630: ED59     [101]    	OUT	(C),E
                        				; A = attention
0632: 7B       [105]    	LD	A,E			;4
0633: ED51     [117]    	OUT	(C),D
                        				; B = save D
0635: 42       [121]    	LD	B,D			;4
                        	WAIT3
0636: 00       [125]    	NOP
                        
0018:                   PAM2B_HEAD_LEN:	.EQU	$-PAM2B_HEAD
                        
0637:                   PAM2B_REPT_ORG:	.EQU	$$
FE18:                   PAM2B_REPT:
0637: ED59     [12]     	OUT	(C),E
0639: ED51     [24]     	OUT	(C),D
0004:                   PAM2B_REPT_LEN:	.EQU	$-PAM2B_REPT
                        
063B:                   PAM2B_TAIL_ORG:	.EQU	$$
FE1C:                   PAM2B_TAIL:
                        				; このブロックは動的再配置されるので
                        				; このブロック"への"ジャンプは困難
                        				; "からの"ジャンプは可能。
063B: ED59     [12]     	OUT	(C),E
063D: 07       [16]     	RLCA				;3
063E: ED51     [28]     	OUT	(C),D
                        				; attention bit
                        				; bit7=1, reload
                        				; must be JP
0640: DA03FE   [38|38]  	JP	C,PAM2B_RELOAD		; jump=9 no=6
                        
0643: 07       [42]     	RLCA				; 3
0644: ED59     [54]     	OUT	(C),E
                        				; bit6=1, stat
                        				; must be JP
0646: DA08FE   [64|64]  	JP	C,PAM2B_STAT		; jump=9 no=6
                        
0649: 07       [68]     	RLCA				; 3
064A: ED51     [80]     	OUT	(C),D
                        	WAIT3
064C: 00       [84]     	NOP
                        				; bit5=0, normal
                        				; must be JP
064D: D20CFE   [94|94]  	JP	NC,PAM2B_NORMAL		; jump=9 no=6
                        				; attention=001, reset
0650: C3CCE2   [104]    	JP	PAM_RESET
0018:                   PAM2B_TAIL_LEN:	.EQU	$-PAM2B_TAIL
                        
                        				; cycle
                        				; 4 * 12*2 + (4+7 + 3+9 + 9+12 + 12+0) = 152
                        
                        	.DEPHASE
                        
                        ; #### PAM3A
                        
                        	.PHASE 0FE00H
0653:                   PAM3A_HEAD_ORG:	.EQU	$$
FE00:                   PAM3A_HEAD:
FE00:                   PAM3A:
                        				; PAM3A
                        				; 12+0:12+3:12+12 = 4:5:6 PAM
                        				; PAM 51clk 120.471kHz
                        				; output PAM wave = normal 5 + antinoise 1
                        
                        				; 1 PAM cycle = 298 clk
                        
                        				; 6.144E6 / (298 + 51*n)
                        
                        				; sampling freqs:
                        				; 0: 20617
                        				; 24: 4037
                        
                        				; prefetch
0653: F1       [10]     	POP	AF
0654: 47       [14]     	LD	B,A
                        				; no STAT for first time
0655: C331FE   [24]     	JP	PAM3A_LOOP
                        
FE05:                   PAM3A_RELOAD:
0658: ED69     [36]     	OUT	(C),L
065A: ED61     [48]     	OUT	(C),H
                        	WAIT3
065C: 00       [52]     	NOP
065D: ED41     [64]     	OUT	(C),B
065F: 310010   [74]     	LD	SP,PAM_BUF		;9
                        	WAIT3
0662: 00       [78]     	NOP
                        
FE10:                   PAM3A_STAT:
                        #if USE_INTR
0663: ED69     [90]     	OUT	(C),L
0665: ED61     [102]    	OUT	(C),H
                        	WAIT3
0667: 00       [106]    	NOP
0668: ED41     [118]    	OUT	(C),B
066A: D3A0     [129]    	OUT	(PAM_HOSTINTR),A		;10+2
                        #else
                        				; STAT_PTR モードでの遅れはしょうがない
                        	OUT	(C),L
                        	OUT	(C),H
                        	WAIT3
                        	OUT	(C),B
                        	LD	(PAM_STAT_PTR),SP		;19+3
                        #endif
                        
FE19:                   PAM3A_NORMAL:
066C: ED69     [141]    	OUT	(C),L
066E: ED61     [153]    	OUT	(C),H
                        	WAIT3
0670: 00       [157]    	NOP
0671: ED41     [169]    	OUT	(C),B
                        				; prefetch
0673: D1       [179]    	POP	DE			;9+3
                        
0674: ED69     [191]    	OUT	(C),L
0676: ED61     [203]    	OUT	(C),H
                        	WAIT3
0678: 00       [207]    	NOP
0679: ED41     [219]    	OUT	(C),B
                        				; prefetch
067B: F1       [229]    	POP	AF			;9+3
                        
067C: ED69     [241]    	OUT	(C),L
067E: ED61     [253]    	OUT	(C),H
                        	WAIT3
0680: 00       [257]    	NOP
0681: ED41     [269]    	OUT	(C),B
                        				; うまくいくかはわからない
                        				; 本来 wait 12 だが PAM 遷移ノイズを
                        				; 低減するのも含めて4clkだけ消費する
0683: 47       [273]    	LD	B,A			;4
FE31:                   PAM3A_LOOP:
                        				; prefetched DE, A=B
                        
0031:                   PAM3A_HEAD_LEN:	.EQU	$-PAM3A_HEAD
                        
0684:                   PAM3A_REPT_ORG:	.EQU	$$
FE31:                   PAM3A_REPT:
0684: ED51     [12]     	OUT	(C),D
0686: ED59     [24]     	OUT	(C),E
                        	WAIT3
0688: 00       [28]     	NOP
0689: ED41     [40]     	OUT	(C),B
                        	WAIT12
068B: 7F       [44]     	LD	A,A			; 4*3=12
068C: 7F       [48]     	LD	A,A
068D: 7F       [52]     	LD	A,A
000A:                   PAM3A_REPT_LEN:	.EQU	$-PAM3A_REPT
                        
068E:                   PAM3A_TAIL_ORG:	.EQU	$$
FE3B:                   PAM3A_TAIL:
                        				; このブロックは動的再配置されるので
                        				; このブロック"への"ジャンプは困難
                        				; "からの"ジャンプは可能。
068E: ED51     [12]     	OUT	(C),D
0690: ED59     [24]     	OUT	(C),E
0692: EB       [28]     	EX	DE,HL			;3
0693: ED41     [40]     	OUT	(C),B
0695: 07       [44]     	RLCA
                        				; attention bit
                        				; bit7=1, reload
                        				; must be JP
0696: DA05FE   [54|54]  	JP	C,PAM3A_RELOAD		; jump=9 no=6
                        
                        	WAIT3
0699: 00       [58]     	NOP
069A: ED69     [70]     	OUT	(C),L
069C: ED61     [82]     	OUT	(C),H
                        	WAIT3
069E: 00       [86]     	NOP
069F: ED41     [98]     	OUT	(C),B
06A1: 07       [102]    	RLCA				; 3
                        				; bit6=1, stat
                        				; must be JP
06A2: DA10FE   [112|112]	JP	C,PAM3A_STAT		; jump=9 no=6
                        
                        	WAIT3
06A5: 00       [116]    	NOP
06A6: ED69     [128]    	OUT	(C),L
06A8: ED61     [140]    	OUT	(C),H
                        	WAIT3
06AA: 00       [144]    	NOP
06AB: ED41     [156]    	OUT	(C),B
06AD: 07       [160]    	RLCA				; 3
                        				; bit5=0, normal
                        				; must be JP
06AE: D219FE   [170|170]	JP	NC,PAM3A_NORMAL		; jump=9 no=6
                        				; attention=001, reset
06B1: C3CCE2   [180]    	JP	PAM_RESET
0026:                   PAM3A_TAIL_LEN:	.EQU	$-PAM3A_TAIL
                        
                        				; cycle
                        				; 5 * (12*3+3+12) + (12*3+3+4) = 298
                        
                        	.DEPHASE
                        
                        ; #### PAM3B
                        
                        	.PHASE 0FE00H
06B4:                   PAM3B_HEAD_ORG:	.EQU	$$
FE00:                   PAM3B_HEAD:
FE00:                   PAM3B:
                        				; PAM3B
                        				; approx 1:1:1
                        				; wait (9,9,12), (12,12,10)
                        				; phase wait 21:21:22
                        				; clk 66, 70
                        				; PAM 93, 88 kHz
                        				; output PAM wave = 2
                        
                        				; 1 PAM cycle = 136 clk
                        
                        				; 6.144E6 / (136 + 36*n)
                        
                        				; sampling freqs:
                        				; 0: 45176
                        				; 38: 4085
                        
                        				; prefetch
06B4: F1       [10]     	POP	AF
06B5: 47       [14]     	LD	B,A
06B6: 07       [18]     	RLCA
                        				; no STAT for first time
06B7: C31AFE   [28]     	JP	PAM3B_LOOP
                        
FE06:                   PAM3B_RELOAD:
06BA: ED59     [40]     	OUT	(C),E
06BC: 310010   [50]     	LD	SP,PAM_BUF		;9
                        
FE0B:                   PAM3B_STAT:
                        #if USE_INTR
06BF: ED41     [62]     	OUT	(C),B
06C1: D3A0     [73]     	OUT	(PAM_HOSTINTR),A		;10+2
                        #else
                        				; STAT_PTR モードでの遅れはしょうがない
                        	OUT	(C),B
                        	LD	(PAM_STAT_PTR),SP		;19+3
                        #endif
                        
FE0F:                   PAM3B_NORMAL:
06C3: ED51     [85]     	OUT	(C),D
                        				; prefetch
06C5: E1       [95]     	POP	HL			;9+3
                        
06C6: ED59     [107]    	OUT	(C),E
                        				; prefetch
06C8: F1       [117]    	POP	AF			;9+3
                        
06C9: ED41     [129]    	OUT	(C),B
06CB: EB       [133]    	EX	DE,HL			;3
06CC: 47       [137]    	LD	B,A			;4
06CD: 07       [141]    	RLCA				;3
FE1A:                   PAM3B_LOOP:
                        				; prefetched DE,B A=RLCA-ed flag
                        
001A:                   PAM3B_HEAD_LEN:	.EQU	$-PAM3B_HEAD
                        
06CE:                   PAM3B_REPT_ORG:	.EQU	$$
FE1A:                   PAM3B_REPT:
06CE: ED51     [12]     	OUT	(C),D
06D0: ED59     [24]     	OUT	(C),E
06D2: ED41     [36]     	OUT	(C),B
0006:                   PAM3B_REPT_LEN:	.EQU	$-PAM3B_REPT
                        
06D4:                   PAM3B_TAIL_ORG:	.EQU	$$
FE20:                   PAM3B_TAIL:
                        				; このブロックは動的再配置されるので
                        				; このブロック"への"ジャンプは困難
                        				; "からの"ジャンプは可能。
06D4: ED51     [12]     	OUT	(C),D
                        				; attention bit
                        				; bit7=1, reload
                        				; must be JP
06D6: DA06FE   [22|22]  	JP	C,PAM3B_RELOAD		; jump=9 no=6
                        
06D9: 07       [26]     	RLCA				; 3
06DA: ED59     [38]     	OUT	(C),E
                        				; bit6=1, stat
                        				; must be JP
06DC: DA0BFE   [48|48]  	JP	C,PAM3B_STAT		; jump=9 no=6
                        
06DF: 07       [52]     	RLCA				; 3
06E0: ED41     [64]     	OUT	(C),B
                        	WAIT3
06E2: 00       [68]     	NOP
                        				; bit5=0, normal
                        				; must be JP
06E3: D20FFE   [78|78]  	JP	NC,PAM3B_NORMAL		; jump=9 no=6
                        				; attention=001, reset
06E6: C3CCE2   [88]     	JP	PAM_RESET
0015:                   PAM3B_TAIL_LEN:	.EQU	$-PAM3B_TAIL
                        
                        
                        	.DEPHASE
                        
                        ; #### PAM1P
                        
                        	.PHASE	0FE00H
06E9:                   PAM1P_HEAD_ORG:	.EQU	$$
FE00:                   PAM1P_HEAD:
FE00:                   PAM1P:
                        				; PAM1P
                        				; PAM1P は正確にはPCMだが
                        				; 動作方式はPAMに近いためこちら。
                        				; Polyphase PCM
                        
                        				; 1 cycle = 87 clk
                        				; 6.144E6 / (87 + 3*n)
                        
                        				; sampling freqs:
                        				; 0: 70621
                        				; 255: 7420
                        
06E9: 210010   [10]     	LD	HL,PAM_BUF		;9
                        
06EC: 0E83     [17]     	LD	C,PSG_ADR
                        				; initial CH0
06EE: 3E08     [24]     	LD	A,8
06F0: D383     [35]     	OUT	(PSG_ADR),A
                        				; rotated next CH
06F2: 0609     [42]     	LD	B,9
06F4: 110A08   [52]     	LD	DE,080AH
                        
                        				; no STAT for first time
06F7: C31CFE   [62]     	JP	PAM1P_LOOP
                        
FE11:                   PAM1P_RELOAD:
06FA: 210010   [72]     	LD	HL,PAM_BUF		;9
                        
FE14:                   PAM1P_STAT:
                        #if USE_INTR
06FD: D3A0     [83]     	OUT	(PAM_HOSTINTR),A		;10+2
                        #else
                        				; STAT_PTR モードでの遅れはしょうがない
                        	LD	(PAM_STAT_PTR),HL		;16+3
                        #endif
                        
FE16:                   PAM1P_NORMAL:
                        				; rotate B,E,D
06FF: 78       [87]     	LD	A,B			;4
0700: 43       [91]     	LD	B,E			;4
0701: 5A       [95]     	LD	E,D			;4
0702: 57       [99]     	LD	D,A			;4
0703: ED41     [111]    	OUT	(C),B			;10+2
                        
FE1C:                   PAM1P_LOOP:
                        
0705: 7E       [118]    	LD	A,(HL)			;6+3
0706: 23       [124]    	INC	HL			;4
                        
0707: D382     [135]    	OUT	(PSG_DAT),A			;10+2
                        
0020:                   PAM1P_HEAD_LEN:	.EQU	$-PAM1P_HEAD
                        
0709:                   PAM1P_REPT_ORG:	.EQU	$$
FE20:                   PAM1P_REPT:
                        	WAIT3
0709: 00       [ 4]     	NOP
0001:                   PAM1P_REPT_LEN:	.EQU	$-PAM1P_REPT
                        
070A:                   PAM1P_TAIL_ORG:	.EQU	$$
FE21:                   PAM1P_TAIL:
                        				; このブロックは動的再配置されるので
                        				; このブロック"への"ジャンプは困難
                        				; "からの"ジャンプは可能。
070A: 07       [ 4]     	RLCA				;3
                        				; attention bit
                        				; bit7=1, reload
                        				; must be JP
070B: DA11FE   [14|14]  	JP	C,PAM1P_RELOAD		; jump=9 no=6
                        
070E: 07       [18]     	RLCA				; 3
                        				; bit6=1, stat
                        				; must be JP
070F: DA14FE   [28|28]  	JP	C,PAM1P_STAT		; jump=9 no=6
                        
0712: 07       [32]     	RLCA				; 3
                        	WAIT3
0713: 00       [36]     	NOP
                        				; bit5=0, normal
                        				; must be JP
0714: D216FE   [46|46]  	JP	NC,PAM1P_NORMAL		; jump=9 no=6
                        				; attention=001, reset
0717: C3CCE2   [56]     	JP	PAM_RESET
0010:                   PAM1P_TAIL_LEN:	.EQU	$-PAM1P_TAIL
                        
                        				; cycle
                        				; 63 + 12 + 12 = 87
                        
                        	.DEPHASE
                        
0466:                   PROG_ORG_LEN:	.EQU	$$-PROG_ORG
                        
                        ; #### interrupt vector
                        	.PHASE	0FFE0H
071A:                   VECTOR_ORG:	.EQU	$$
FFE0:                   VECTOR:
                        
FFE0:                   VEC_INT1:
071A: F8FF              	DW	INTR_IGN
FFE2:                   VEC_INT2:
071C: F8FF              	DW	INTR_IGN
FFE4:                   VEC_PRT0:
071E: 25E0              	DW	INTR_PRT0
FFE6:                   VEC_PRT1:
0720: F8FF              	DW	INTR_IGN
FFE8:                   VEC_DMAC0:
0722: F8FF              	DW	INTR_IGN
FFEA:                   VEC_DMAC1:
0724: F8FF              	DW	INTR_IGN
FFEC:                   VEC_SIO:
0726: F8FF              	DW	INTR_IGN
FFEE:                   VEC_ASCI0:
0728: 25E2              	DW	INTR_ASCI0
FFF0:                   VEC_ASCI1:
072A: 25E2              	DW	INTR_ASCI1
FFF2:                   VEC_PT2IN:
072C: F8FF              	DW	INTR_IGN
FFF4:                   VEC_PT2OUT:
072E: F8FF              	DW	INTR_IGN
FFF6:                   VEC_PT2OVF:
0730: F8FF              	DW	INTR_IGN
                        			; 本当はここはベクタテーブルだが
                        			; 使われることはないので押し込む。
FFF8:                   INTR_IGN:
0732: FB       [ 4]     	EI
0733: ED4D     [18]     	RETI
                        
001B:                   VECTOR_ORG_LEN:	.EQU	$$-VECTOR_ORG
                        
                        	.DEPHASE
0735:                   XPLX_FIRMWARE_LEN::	.EQU	$


; +++ segments +++

#CODE          = $0000 =     0,  size = $0735 =  1845

; +++ global symbols +++

BBR                = $0039 =    57          xplx.asm:624
CBAR               = $003A =    58          xplx.asm:625
CBR                = $0038 =    56          xplx.asm:623
DCNTL              = $0032 =    50          xplx.asm:614
DEVICES_DISPATCH   = $E02F = 57391          xplx.asm:803 (unused)
DEVID_FDC          = $0007 =     7          xplx.asm:217 (unused)
DEVID_LPR          = $0006 =     6          xplx.asm:216 (unused)
DEVID_PAM          = $0002 =     2          xplx.asm:212 (unused)
DEVID_PCM          = $0003 =     3          xplx.asm:213 (unused)
DEVID_PSG          = $0004 =     4          xplx.asm:214 (unused)
DEVID_SIO0         = $0008 =     8          xplx.asm:218 (unused)
DEVID_SIO1         = $0009 =     9          xplx.asm:219 (unused)
DEVID_SPK          = $0005 =     5          xplx.asm:215 (unused)
DEVID_TIME         = $0001 =     1          xplx.asm:211 (unused)
DEVID_XPBUS        = $0000 =     0          xplx.asm:210 (unused)
ENTRY              = $0200 =   512          xplx.asm:582
FDC_BUF            = $A000 = 40960          xplx.asm:749
FDC_BUF_LEN        = $4000 = 16384          xplx.asm:754 (unused)
FDC_CMD            = $0171 =   369          xplx.asm:519
FDC_CMD_START      = $0001 =     1          xplx.asm:527 (unused)
FDC_DISPATCH       = $E207 = 57863          xplx.asm:1176
FDC_READY          = $0170 =   368          xplx.asm:517
FDC_RESULT         = $0172 =   370          xplx.asm:521
FDC_RUN            = $0173 =   371          xplx.asm:523 (unused)
HOSTINTR1          = $00B0 =   176          xplx.asm:255 (unused)
HOSTINTR5          = $00A0 =   160          xplx.asm:257
ICR                = $003F =    63          xplx.asm:607
IL                 = $0033 =    51          xplx.asm:654
INITIAL_SP         = $1000 =  4096          xplx.asm:279
INIT_PSG           = $028F =   655          xplx.asm:701
INT0               = $0038 =    56          xplx.asm:374 (unused)
INTR_ASCI0         = $E225 = 57893          xplx.asm:1202
INTR_ASCI1         = $E225 = 57893          xplx.asm:1203
INTR_IGN           = $FFF8 = 65528          xplx.asm:1996
INTR_INT0          = $E225 = 57893          xplx.asm:1201
INTR_PRT0          = $E025 = 57381          xplx.asm:779
ITC                = $0034 =    52          xplx.asm:648
LPR_BUF            = $9000 = 36864          xplx.asm:745
LPR_BUF_LEN        = $1000 =  4096          xplx.asm:748 (unused)
LPR_CMD            = $0161 =   353          xplx.asm:505
LPR_CMD_START      = $0001 =     1          xplx.asm:513 (unused)
LPR_DISPATCH       = $E1FD = 57853          xplx.asm:1168
LPR_READY          = $0160 =   352          xplx.asm:503
LPR_RESULT         = $0162 =   354          xplx.asm:507
LPR_RUN            = $0163 =   355          xplx.asm:509 (unused)
NMI                = $0066 =   102          xplx.asm:378 (unused)
PAM1P              = $FE00 = 65024          xplx.asm:1874 (unused)
PAM1P_HEAD         = $FE00 = 65024          xplx.asm:1873
PAM1P_HEAD_LEN     = $0020 =    32          xplx.asm:1926 (unused)
PAM1P_HEAD_ORG     = $06E9 =  1769          xplx.asm:1872 (unused)
PAM1P_LOOP         = $FE1C = 65052          xplx.asm:1919
PAM1P_NORMAL       = $FE16 = 65046          xplx.asm:1911
PAM1P_RELOAD       = $FE11 = 65041          xplx.asm:1900
PAM1P_REPT         = $FE20 = 65056          xplx.asm:1929
PAM1P_REPT_LEN     = $0001 =     1          xplx.asm:1931 (unused)
PAM1P_REPT_ORG     = $0709 =  1801          xplx.asm:1928 (unused)
PAM1P_STAT         = $FE14 = 65044          xplx.asm:1903
PAM1P_TAIL         = $FE21 = 65057          xplx.asm:1934
PAM1P_TAIL_LEN     = $0010 =    16          xplx.asm:1956 (unused)
PAM1P_TAIL_ORG     = $070A =  1802          xplx.asm:1933 (unused)
PAM2A              = $FE00 = 65024          xplx.asm:1443 (unused)
PAM2A_HEAD         = $FE00 = 65024          xplx.asm:1442
PAM2A_HEAD_LEN     = $0021 =    33          xplx.asm:1499
PAM2A_HEAD_ORG     = $05DA =  1498          xplx.asm:1441
PAM2A_LOOP         = $FE1A = 65050          xplx.asm:1489
PAM2A_NORMAL       = $FE11 = 65041          xplx.asm:1478
PAM2A_RELOAD       = $FE03 = 65027          xplx.asm:1460
PAM2A_REPT         = $FE21 = 65057          xplx.asm:1502
PAM2A_REPT_LEN     = $0007 =     7          xplx.asm:1506
PAM2A_REPT_ORG     = $05FB =  1531          xplx.asm:1501
PAM2A_STAT         = $FE0B = 65035          xplx.asm:1466
PAM2A_TAIL         = $FE28 = 65064          xplx.asm:1509
PAM2A_TAIL_LEN     = $001D =    29          xplx.asm:1538
PAM2A_TAIL_ORG     = $0602 =  1538          xplx.asm:1508
PAM2B              = $FE00 = 65024          xplx.asm:1551 (unused)
PAM2B_HEAD         = $FE00 = 65024          xplx.asm:1550
PAM2B_HEAD_LEN     = $0018 =    24          xplx.asm:1600
PAM2B_HEAD_ORG     = $061F =  1567          xplx.asm:1549
PAM2B_LOOP         = $FE11 = 65041          xplx.asm:1590
PAM2B_NORMAL       = $FE0C = 65036          xplx.asm:1585
PAM2B_RELOAD       = $FE03 = 65027          xplx.asm:1571
PAM2B_REPT         = $FE18 = 65048          xplx.asm:1603
PAM2B_REPT_LEN     = $0004 =     4          xplx.asm:1606
PAM2B_REPT_ORG     = $0637 =  1591          xplx.asm:1602
PAM2B_STAT         = $FE08 = 65032          xplx.asm:1575
PAM2B_TAIL         = $FE1C = 65052          xplx.asm:1609
PAM2B_TAIL_LEN     = $0018 =    24          xplx.asm:1635
PAM2B_TAIL_ORG     = $063B =  1595          xplx.asm:1608
PAM3A              = $FE00 = 65024          xplx.asm:1647 (unused)
PAM3A_HEAD         = $FE00 = 65024          xplx.asm:1646
PAM3A_HEAD_LEN     = $0031 =    49          xplx.asm:1717
PAM3A_HEAD_ORG     = $0653 =  1619          xplx.asm:1645
PAM3A_LOOP         = $FE31 = 65073          xplx.asm:1714
PAM3A_NORMAL       = $FE19 = 65049          xplx.asm:1691
PAM3A_RELOAD       = $FE05 = 65029          xplx.asm:1667
PAM3A_REPT         = $FE31 = 65073          xplx.asm:1720
PAM3A_REPT_LEN     = $000A =    10          xplx.asm:1726
PAM3A_REPT_ORG     = $0684 =  1668          xplx.asm:1719
PAM3A_STAT         = $FE10 = 65040          xplx.asm:1675
PAM3A_TAIL         = $FE3B = 65083          xplx.asm:1729
PAM3A_TAIL_LEN     = $0026 =    38          xplx.asm:1764
PAM3A_TAIL_ORG     = $068E =  1678          xplx.asm:1728
PAM3B              = $FE00 = 65024          xplx.asm:1776 (unused)
PAM3B_HEAD         = $FE00 = 65024          xplx.asm:1775
PAM3B_HEAD_LEN     = $001A =    26          xplx.asm:1830
PAM3B_HEAD_ORG     = $06B4 =  1716          xplx.asm:1774
PAM3B_LOOP         = $FE1A = 65050          xplx.asm:1827
PAM3B_NORMAL       = $FE0F = 65039          xplx.asm:1814
PAM3B_RELOAD       = $FE06 = 65030          xplx.asm:1800
PAM3B_REPT         = $FE1A = 65050          xplx.asm:1833
PAM3B_REPT_LEN     = $0006 =     6          xplx.asm:1837
PAM3B_REPT_ORG     = $06CE =  1742          xplx.asm:1832
PAM3B_STAT         = $FE0B = 65035          xplx.asm:1804
PAM3B_TAIL         = $FE20 = 65056          xplx.asm:1840
PAM3B_TAIL_LEN     = $0015 =    21          xplx.asm:1864
PAM3B_TAIL_ORG     = $06D4 =  1748          xplx.asm:1839
PAM_BUF            = $1000 =  4096          xplx.asm:735
PAM_BUF_LEN        = $7000 = 28672          xplx.asm:739 (unused)
PAM_CMD            = $0121 =   289          xplx.asm:426
PAM_CMD_QUERY      = $0002 =     2          xplx.asm:223
PAM_CMD_START      = $0001 =     1          xplx.asm:222
PAM_CYCLE_CLK      = $0126 =   294          xplx.asm:437
PAM_DISPATCH       = $E228 = 57896          xplx.asm:1210
PAM_DRIVER         = $FE00 = 65024          xplx.asm:1435
PAM_DRIVER_MAP     = $E2E6 = 58086          xplx.asm:1382
PAM_DRIVER_MAP_LEN = $0040 =    64          xplx.asm:1426
PAM_ENC            = $0124 =   292          xplx.asm:433
PAM_ENC_MAP        = $E236 = 57910          xplx.asm:1223
PAM_ENC_PAM1P      = $0005 =     5          xplx.asm:229 (unused)
PAM_ENC_PAM2A      = $0001 =     1          xplx.asm:225 (unused)
PAM_ENC_PAM2B      = $0002 =     2          xplx.asm:226 (unused)
PAM_ENC_PAM3A      = $0003 =     3          xplx.asm:227 (unused)
PAM_ENC_PAM3B      = $0004 =     4          xplx.asm:228 (unused)
PAM_ERROR_ENC      = $E24E = 57934          xplx.asm:1240
PAM_ERROR_PARAM    = $E24F = 57935          xplx.asm:1242
PAM_HOSTINTR       = $00A0 =   160          xplx.asm:260
PAM_QUERY          = $E255 = 57941          xplx.asm:1247
PAM_READY          = $0120 =   288          xplx.asm:424
PAM_REPT           = $0125 =   293          xplx.asm:435
PAM_REPT_CLK       = $0128 =   296          xplx.asm:439 (unused)
PAM_REPT_END       = $E2B6 = 58038          xplx.asm:1328
PAM_REPT_LOOP      = $E2A9 = 58025          xplx.asm:1314
PAM_REPT_MAX       = $0129 =   297          xplx.asm:441 (unused)
PAM_RESET          = $E2CC = 58060          xplx.asm:1363
PAM_RESULT         = $0122 =   290          xplx.asm:428
PAM_RUN            = $0123 =   291          xplx.asm:430
PAM_START          = $E27A = 57978          xplx.asm:1277
PAM_START_OK       = $E28E = 57998          xplx.asm:1289
PAM_STAT_PTR       = $012E =   302          xplx.asm:445 (unused)
PCM1               = $E131 = 57649          xplx.asm:1021
PCM2               = $E139 = 57657          xplx.asm:1029
PCM3               = $E148 = 57672          xplx.asm:1040
PCM_BUF            = $1000 =  4096          xplx.asm:736
PCM_BUF_LEN        = $7000 = 28672          xplx.asm:740 (unused)
PCM_CMD            = $0131 =   305          xplx.asm:452
PCM_CMD_START      = $0001 =     1          xplx.asm:231
PCM_DISPATCH       = $E086 = 57478          xplx.asm:872
PCM_ENC            = $0134 =   308          xplx.asm:459
PCM_ENC_PCM1       = $0001 =     1          xplx.asm:233 (unused)
PCM_ENC_PCM2       = $0002 =     2          xplx.asm:234 (unused)
PCM_ENC_PCM3       = $0003 =     3          xplx.asm:235 (unused)
PCM_ERROR          = $E08C = 57484          xplx.asm:877
PCM_EXIT           = $E12C = 57644          xplx.asm:1013
PCM_HOSTINTR       = $00A0 =   160          xplx.asm:262
PCM_INTR           = $E0FC = 57596          xplx.asm:962
PCM_INTR_JMP       = $E105 = 57605          xplx.asm:972
PCM_INTR_NEXT      = $E107 = 57607          xplx.asm:975
PCM_NORMAL         = $E12C = 57644          xplx.asm:1012
PCM_PRT1_TIMER     = $0136 =   310          xplx.asm:462
PCM_READY          = $0130 =   304          xplx.asm:450
PCM_RELOAD         = $E127 = 57639          xplx.asm:1004
PCM_RESET          = $E111 = 57617          xplx.asm:987 (unused)
PCM_RESULT         = $0132 =   306          xplx.asm:454
PCM_RUN            = $0133 =   307          xplx.asm:456
PCM_SET            = $E0CC = 57548          xplx.asm:928
PCM_SET_PCM1       = $E0C9 = 57545          xplx.asm:926
PCM_SET_PCM2       = $E0C4 = 57540          xplx.asm:923
PCM_SET_PCM3       = $E0BF = 57535          xplx.asm:920 (unused)
PCM_START          = $E090 = 57488          xplx.asm:881
PCM_START_OK       = $E0A5 = 57509          xplx.asm:898
PCM_STAT           = $E12A = 57642          xplx.asm:1006
PCM_STAT_PTR       = $013E =   318          xplx.asm:466 (unused)
PRIVATE_RAM        = $E000 = 57344          xplx.asm:757
PRIVATE_SP         = $F000 = 61440          xplx.asm:280
PROG_ORG           = $02B4 =   692          xplx.asm:756
PROG_ORG_LEN       = $0466 =  1126          xplx.asm:1963
PSG_ADR            = $0083 =   131          xplx.asm:275
PSG_BUF            = $8000 = 32768          xplx.asm:741
PSG_BUF_LEN        = $1000 =  4096          xplx.asm:744 (unused)
PSG_CLEAR_06       = $0297 =   663          xplx.asm:708
PSG_CLEAR_8F       = $02AC =   684          xplx.asm:725
PSG_CMD            = $0141 =   321          xplx.asm:473
PSG_DAT            = $0082 =   130          xplx.asm:276
PSG_DISPATCH       = $E1F3 = 57843          xplx.asm:1160
PSG_IN             = $0083 =   131          xplx.asm:277
PSG_READY          = $0140 =   320          xplx.asm:471
PSG_RESULT         = $0142 =   322          xplx.asm:475
PSG_RUN            = $0143 =   323          xplx.asm:477 (unused)
RCR                = $0036 =    54          xplx.asm:618
RESET              = $0000 =     0          xplx.asm:370 (unused)
RLDR0H             = $000F =    15          xplx.asm:268
RLDR0L             = $000E =    14          xplx.asm:267
RLDR1H             = $0017 =    23          xplx.asm:273
RLDR1L             = $0016 =    22          xplx.asm:272
RMCR               = $0051 =    81          xplx.asm:643
SIO0_CMD           = $0181 =   385          xplx.asm:533
SIO0_DISPATCH      = $E211 = 57873          xplx.asm:1185
SIO0_READY         = $0180 =   384          xplx.asm:531
SIO0_RESULT        = $0182 =   386          xplx.asm:535
SIO0_RUN           = $0183 =   387          xplx.asm:537 (unused)
SIO0_RX            = $018C =   396          xplx.asm:551 (unused)
SIO0_RXCMD         = $018A =   394          xplx.asm:547 (unused)
SIO0_RXSTAT        = $018B =   395          xplx.asm:549 (unused)
SIO0_TX            = $0186 =   390          xplx.asm:544 (unused)
SIO0_TXCMD         = $0184 =   388          xplx.asm:540 (unused)
SIO0_TXSTAT        = $0185 =   389          xplx.asm:542 (unused)
SIO1_CMD           = $0191 =   401          xplx.asm:558
SIO1_DISPATCH      = $E21B = 57883          xplx.asm:1193
SIO1_READY         = $0190 =   400          xplx.asm:556
SIO1_RESULT        = $0192 =   402          xplx.asm:560
SIO1_RUN           = $0193 =   403          xplx.asm:562 (unused)
SIO1_RX            = $019C =   412          xplx.asm:576 (unused)
SIO1_RXCMD         = $019A =   410          xplx.asm:572 (unused)
SIO1_RXSTAT        = $019B =   411          xplx.asm:574 (unused)
SIO1_TX            = $0196 =   406          xplx.asm:569 (unused)
SIO1_TXCMD         = $0194 =   404          xplx.asm:565 (unused)
SIO1_TXSTAT        = $0195 =   405          xplx.asm:567 (unused)
SPK_CMD            = $0151 =   337          xplx.asm:484
SPK_CMD_KEEP       = $0003 =     3          xplx.asm:239
SPK_CMD_START      = $0001 =     1          xplx.asm:237
SPK_CMD_STOP       = $0002 =     2          xplx.asm:238
SPK_DISPATCH       = $E163 = 57699          xplx.asm:1059
SPK_EXIT           = $E1E8 = 57832          xplx.asm:1149
SPK_FREQ           = $0156 =   342          xplx.asm:494
SPK_KEEP           = $E1DD = 57821          xplx.asm:1139
SPK_PSGR7          = $E1F2 = 57842          xplx.asm:1156
SPK_READY          = $0150 =   336          xplx.asm:482
SPK_REMAIN         = $015A =   346          xplx.asm:498
SPK_RESULT         = $0152 =   338          xplx.asm:486
SPK_RUN            = $0153 =   339          xplx.asm:488
SPK_START          = $E175 = 57717          xplx.asm:1071
SPK_STOP           = $E1BB = 57787          xplx.asm:1113
SPK_STOP_CORE      = $E1C0 = 57792          xplx.asm:1118
SPK_TIME           = $0158 =   344          xplx.asm:496
SPK_VOL            = $0154 =   340          xplx.asm:491
TCR                = $0010 =    16          xplx.asm:269
TIMECOUNTER_INCR   = $E028 = 57384          xplx.asm:795 (unused)
TIME_CMD           = $0111 =   273          xplx.asm:413
TIME_DISPATCH      = $E07C = 57468          xplx.asm:856 (unused)
TIME_READY         = $0110 =   272          xplx.asm:411
TIME_RESULT        = $0112 =   274          xplx.asm:415
TIME_RUN           = $0113 =   275          xplx.asm:417 (unused)
TIME_TIMECOUNTER   = $0114 =   276          xplx.asm:419
TMDR0H             = $000D =    13          xplx.asm:266
TMDR0L             = $000C =    12          xplx.asm:265
TMDR1H             = $0015 =    21          xplx.asm:271
TMDR1L             = $0014 =    20          xplx.asm:270
USE_INTR           = $0001 =     1          xplx.asm:251
VECTOR             = $FFE0 = 65504          xplx.asm:1968
VECTOR_ORG         = $071A =  1818          xplx.asm:1967
VECTOR_ORG_LEN     = $001B =    27          xplx.asm:2000
VEC_ASCI0          = $FFEE = 65518          xplx.asm:1984 (unused)
VEC_ASCI1          = $FFF0 = 65520          xplx.asm:1986 (unused)
VEC_DMAC0          = $FFE8 = 65512          xplx.asm:1978 (unused)
VEC_DMAC1          = $FFEA = 65514          xplx.asm:1980 (unused)
VEC_INT1           = $FFE0 = 65504          xplx.asm:1970 (unused)
VEC_INT2           = $FFE2 = 65506          xplx.asm:1972 (unused)
VEC_PRT0           = $FFE4 = 65508          xplx.asm:1974 (unused)
VEC_PRT1           = $FFE6 = 65510          xplx.asm:1976
VEC_PT2IN          = $FFF2 = 65522          xplx.asm:1988 (unused)
VEC_PT2OUT         = $FFF4 = 65524          xplx.asm:1990 (unused)
VEC_PT2OVF         = $FFF6 = 65526          xplx.asm:1992 (unused)
VEC_SIO            = $FFEC = 65516          xplx.asm:1982 (unused)
XPBUS              = $E000 = 57344          xplx.asm:759
XPBUS_CMD          = $0101 =   257          xplx.asm:391
XPBUS_DISPATCH     = $E072 = 57458          xplx.asm:846
XPBUS_INTR1_DEV    = $010A =   266          xplx.asm:404 (unused)
XPBUS_INTR5_DEV    = $010C =   268          xplx.asm:406 (unused)
XPBUS_PRT0_TIMER   = $0108 =   264          xplx.asm:402
XPBUS_READY        = $0100 =   256          xplx.asm:389
XPBUS_RESULT       = $0102 =   258          xplx.asm:393
XPBUS_RUN          = $0103 =   259          xplx.asm:395 (unused)
XPBUS_STAT_RESET   = $0104 =   260          xplx.asm:398
XPLX_FIRMWARE_LEN  = $0735 =  1845          xplx.asm:2003 (unused)
XPLX_MAGIC         = $00FC =   252          xplx.asm:382 (unused)
XPLX_R_ERROR_PARAM = $00FE =   254          xplx.asm:244
XPLX_R_OK          = $0001 =     1          xplx.asm:243
XPLX_R_UNKNOWN_CMD = $00FF =   255          xplx.asm:245
XPLX_VAR_BASE      = $0100 =   256          xplx.asm:388 (unused)
_end               = $0735 =  1845          xplx.asm:368 (unused)
_size              = $0735 =  1845          xplx.asm:368 (unused)
_z180_             = $0001 =     1          xplx.asm:206 (unused)


total time: 0.0135 sec.
no errors
